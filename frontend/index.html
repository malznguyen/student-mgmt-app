<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Management Dashboard</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/@alpinejs/focus@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const SESSION_CACHE_KEY = 'session_cache_v1';

    function createSessionStore() {
      let cached = null;
      try {
        const raw = localStorage.getItem(SESSION_CACHE_KEY);
        cached = raw ? JSON.parse(raw) : null;
      } catch (error) {
        console.warn('Unable to parse cached session.', error);
      }

      return {
        user: cached && typeof cached === 'object' ? cached.user || null : null,
        isAdmin: cached && typeof cached === 'object' ? !!cached.isAdmin : false,
        setFromUser(user) {
          this.user = user || null;
          this.isAdmin = !!(user && user.role === 'admin');
          this.persist();
        },
        setFromServer(isAdmin) {
          this.isAdmin = !!isAdmin;
          if (!this.isAdmin) {
            this.user = null;
          }
          this.persist();
        },
        reset() {
          this.user = null;
          this.isAdmin = false;
          this.persist();
        },
        persist() {
          try {
            if (this.user || this.isAdmin) {
              localStorage.setItem(
                SESSION_CACHE_KEY,
                JSON.stringify({ user: this.user, isAdmin: this.isAdmin })
              );
            } else {
              localStorage.removeItem(SESSION_CACHE_KEY);
            }
          } catch (error) {
            console.warn('Unable to persist session cache.', error);
          }
        }
      };
    }

    async function refreshSessionFromServer(store) {
      try {
        const response = await fetch('/api/me', { credentials: 'same-origin' });
        if (!response.ok) {
          throw new Error('Failed to fetch session');
        }
        const data = await response.json();
        store.setFromServer(Boolean(data && data.is_admin));
      } catch (error) {
        console.error('Unable to refresh session state.', error);
        store.setFromServer(false);
      }
    }

    document.addEventListener('alpine:init', () => {
      const sessionStore = createSessionStore();
      Alpine.store('session', sessionStore);
      refreshSessionFromServer(sessionStore);
    });

    function layoutShell() {
      return {
        sidebarOpen: false,
        loggingOut: false,
        async logout() {
          if (this.loggingOut) return;
          this.loggingOut = true;
          const sessionStore = Alpine.store('session');
          try {
            await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' });
          } catch (error) {
            console.error('Logout failed', error);
          } finally {
            sessionStore.reset();
            await refreshSessionFromServer(sessionStore);
            window.location.reload();
          }
        }
      };
    }
  </script>
</head>
<body class="min-h-screen bg-slate-100 text-slate-700" x-data="layoutShell()" x-on:keydown.escape.window="sidebarOpen = false">
  <div class="flex min-h-screen">
    <div x-cloak x-show="sidebarOpen" x-transition.opacity class="fixed inset-0 z-30 bg-slate-900/40 md:hidden" aria-hidden="true" @click="sidebarOpen = false"></div>
    <aside x-cloak x-show="sidebarOpen" x-transition:enter="transition transform duration-200" x-transition:enter-start="-translate-x-full" x-transition:enter-end="translate-x-0" x-transition:leave="transition transform duration-200" x-transition:leave-start="translate-x-0" x-transition:leave-end="-translate-x-full" class="fixed inset-y-0 left-0 z-40 w-72 bg-white border-r border-slate-200 md:static md:translate-x-0 md:block">
      <div class="flex items-center gap-3 px-6 h-16 border-b border-slate-100">
        <img src="/assets/logo.svg" alt="Student Management logo" class="h-9 w-9" />
        <div>
          <p class="text-sm uppercase tracking-widest text-slate-400">Student Mgmt</p>
          <p class="text-base font-semibold text-slate-800">Admin Console</p>
        </div>
      </div>
      <nav class="px-4 py-6 space-y-1 text-sm font-medium">
        <a href="/" aria-current="page" class="flex items-center gap-3 rounded-xl px-3 py-2 bg-slate-900/5 text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-900 text-white">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M3 9.75 12 3l9 6.75V21a.75.75 0 0 1-.75.75H3.75A.75.75 0 0 1 3 21V9.75Z" /><path d="M9 21v-6h6v6" stroke-linecap="round" /></svg>
          </span>
          Dashboard
        </a>
        <a href="/pages/students.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" /><path d="M4.5 21a7.5 7.5 0 0 1 15 0" stroke-linecap="round" /></svg>
          </span>
          Students
        </a>
        <a href="/pages/courses.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 5.25h15" stroke-linecap="round" /><path d="M6 4.5h12A1.5 1.5 0 0 1 19.5 6v13.5a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1-.75-.75V6A1.5 1.5 0 0 1 6 4.5Z" /><path d="M9 9h6m-6 4.5h6" stroke-linecap="round" /></svg>
          </span>
          Courses
        </a>
        <a href="/pages/sections.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 6.75h15" stroke-linecap="round" /><path d="M4.5 12h15" stroke-linecap="round" /><path d="M4.5 17.25h15" stroke-linecap="round" /></svg>
          </span>
          Sections
        </a>
        <a href="/pages/enrollments.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 4.5h15v15h-15z" /><path d="M8.25 8.25h7.5v7.5h-7.5z" /><path d="M8.25 4.5v3.75M15.75 4.5v3.75M4.5 12h3.75m7.5 0H19.5M8.25 16.5V19.5m7.5-3v3" stroke-linecap="round" /></svg>
          </span>
          Enrollments
        </a>
        <a href="/pages/reports.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 19.5 9 13.5l4.5 3 6-9" stroke-linecap="round" stroke-linejoin="round" /><path d="M3.75 5.25h16.5" stroke-linecap="round" /></svg>
          </span>
          Reports
        </a>
        <template x-if="$store.session.isAdmin">
          <span class="flex items-center gap-3 rounded-xl px-3 py-2 text-emerald-700 bg-emerald-100/80 font-semibold">
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-emerald-600 text-white">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="m5.25 12 3.5 3.5L18.75 5.5" stroke-linecap="round" stroke-linejoin="round" /></svg>
            </span>
            Admin access
          </span>
        </template>
        <template x-if="!$store.session.isAdmin">
          <a href="/pages/login.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900" title="Admin only">
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M9 5.25 15.75 12 9 18.75" stroke-linecap="round" stroke-linejoin="round" /></svg>
            </span>
            Login
          </a>
        </template>
      </nav>
      <div class="mt-auto px-6 py-6 border-t border-slate-100 text-xs text-slate-500">
        <p>Academic year <span class="font-semibold text-slate-700">2025</span></p>
        <p class="mt-1">Updated <span class="font-semibold text-slate-700">today</span></p>
      </div>
    </aside>

    <div class="flex-1 flex flex-col min-h-screen">
      <header class="sticky top-0 z-20 border-b border-slate-200 bg-white/95 backdrop-blur">
        <div class="flex items-center justify-between px-4 sm:px-6 h-16">
          <div class="flex items-center gap-3">
            <button type="button" class="inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-600 shadow-sm transition hover:border-slate-300 hover:text-slate-900 md:hidden" @click="sidebarOpen = true" aria-label="Open navigation menu">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 7.5h15M4.5 12h15M4.5 16.5h15" stroke-linecap="round" /></svg>
            </button>
            <div>
              <p class="text-xs uppercase tracking-widest text-slate-400">Dashboard</p>
              <h1 class="text-lg font-semibold text-slate-900">Welcome back, team</h1>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <nav class="hidden md:flex items-center gap-6 text-sm font-medium text-slate-600">
              <a href="/" class="text-slate-900">Overview</a>
              <a href="/pages/students.html" class="hover:text-slate-900">Students</a>
              <a href="/pages/courses.html" class="hover:text-slate-900">Courses</a>
              <a href="/pages/sections.html" class="hover:text-slate-900">Sections</a>
              <a href="/pages/enrollments.html" class="hover:text-slate-900">Enrollments</a>
              <a href="/pages/reports.html" class="hover:text-slate-900">Reports</a>
            </nav>
            <div class="flex items-center gap-3 text-xs sm:text-sm font-semibold text-slate-600">
              <template x-if="$store.session.isAdmin">
                <div class="flex items-center gap-3">
                  <span class="inline-flex items-center gap-2 rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">
                    <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                    Admin
                  </span>
                  <button type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-60" @click="logout" :disabled="loggingOut" :title="loggingOut ? 'Signing out…' : 'Sign out of admin mode'">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M15.75 8.25 19.5 12l-3.75 3.75" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.5 12h-9" stroke-linecap="round" stroke-linejoin="round" /><path d="M12 19.5H6.75A2.25 2.25 0 0 1 4.5 17.25v-10.5A2.25 2.25 0 0 1 6.75 4.5H12" stroke-linecap="round" stroke-linejoin="round" /></svg>
                    <span x-text="loggingOut ? 'Signing out…' : 'Logout'"></span>
                  </button>
                </div>
              </template>
              <template x-if="!$store.session.isAdmin">
                <a href="/pages/login.html" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:text-slate-900" title="Sign in for admin features">
                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M9 5.25 15.75 12 9 18.75" stroke-linecap="round" stroke-linejoin="round" /><path d="M4.5 12h11.25" stroke-linecap="round" stroke-linejoin="round" /></svg>
                  Login
                </a>
              </template>
            </div>
          </div>
        </div>
      </header>

      <main class="flex-1">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10" x-data="dashboardPage()">
          <section class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
            <div>
              <h2 class="text-3xl font-semibold text-slate-900">Academic snapshot</h2>
              <p class="mt-2 text-slate-600">Track enrollment, retention, and performance metrics for the current academic cycle.</p>
            </div>
            <div class="flex flex-wrap gap-3">
              <a href="/pages/students.html" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm hover:border-slate-300" x-show="$store.session.isAdmin" x-cloak>
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M12 6v12m6-6H6" stroke-linecap="round" /></svg>
                Add student
              </a>
              <a href="/pages/courses.html" class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-smooth">
                Manage catalog
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M9 5.25 15.75 12 9 18.75" stroke-linecap="round" stroke-linejoin="round" /></svg>
              </a>
            </div>
          </section>

          <div x-cloak x-show="error" x-transition class="mt-8 rounded-xl border border-rose-200 bg-rose-50/80 p-4 text-sm text-rose-700" role="alert">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div>
                <p class="font-semibold">Unable to load dashboard metrics.</p>
                <p class="mt-1 text-rose-600" x-text="error"></p>
              </div>
              <button type="button" @click="fetchStats" class="inline-flex items-center gap-2 rounded-full border border-rose-200 bg-white px-4 py-2 text-xs font-semibold text-rose-700 shadow-sm hover:border-rose-300">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4.5 4.5v6h6" stroke-linecap="round" stroke-linejoin="round" /><path d="M3 10.5A9 9 0 0 1 12 3a9 9 0 0 1 9 9" stroke-linecap="round" /></svg>
                Retry
              </button>
            </div>
          </div>

          <section class="mt-10">
            <div class="grid gap-6 sm:grid-cols-2 xl:grid-cols-4">
              <template x-if="loading">
                <template x-for="i in 4" :key="`card-skel-${i}`">
                  <article class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                    <div class="flex items-center justify-between">
                      <div class="space-y-3">
                        <span class="skeleton-line h-3 w-20 rounded"></span>
                        <span class="skeleton-line h-6 w-24 rounded"></span>
                      </div>
                      <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-slate-100 text-slate-300">
                        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4.5 12.75 9 17.25 19.5 6.75" stroke-linecap="round" stroke-linejoin="round" /></svg>
                      </span>
                    </div>
                    <span class="mt-6 block skeleton-line h-3 w-28 rounded"></span>
                  </article>
                </template>
              </template>
              <template x-if="!loading">
                <template x-for="card in cards" :key="card.name">
                  <article class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                    <div class="flex items-center justify-between">
                      <div>
                        <p class="text-xs uppercase tracking-wide text-slate-400" x-text="card.name"></p>
                        <p class="mt-2 text-3xl font-semibold text-slate-900" x-text="card.value"></p>
                      </div>
                      <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-slate-900/10 text-slate-700">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M4.5 12.75 9 17.25 19.5 6.75" stroke-linecap="round" stroke-linejoin="round" /></svg>
                      </span>
                    </div>
                    <p class="mt-3 text-xs font-medium text-emerald-600" x-text="card.delta"></p>
                  </article>
                </template>
              </template>
            </div>
          </section>

          <section class="mt-10 grid gap-6 lg:grid-cols-5">
            <article class="lg:col-span-3 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
              <header class="flex items-center justify-between">
                <div>
                  <h3 class="text-lg font-semibold text-slate-900">Students by major</h3>
                  <p class="text-sm text-slate-500">Current headcount across departments</p>
                </div>
                <span class="rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">Updated weekly</span>
              </header>
              <div class="mt-6">
                <template x-if="loading">
                  <div class="h-72 rounded-xl border border-slate-200 bg-slate-50/80"></div>
                </template>
                <template x-if="!loading && !stats.students_by_major.length">
                  <div class="flex h-72 items-center justify-center rounded-xl border border-dashed border-slate-200 bg-slate-50/80 text-sm text-slate-500">
                    No majors to display yet.
                  </div>
                </template>
                <div x-show="!loading && stats.students_by_major.length" class="relative h-72" x-cloak>
                  <canvas x-ref="majorCanvas" aria-label="Bar chart showing students by major" role="img"></canvas>
                </div>
              </div>
            </article>
            <article class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
              <header class="flex items-center justify-between">
                <div>
                  <h3 class="text-lg font-semibold text-slate-900">Enrollments per semester</h3>
                  <p class="text-sm text-slate-500">Multi-term trend, including summer sessions</p>
                </div>
                <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">Rolling 4 terms</span>
              </header>
              <div class="mt-6">
                <template x-if="loading">
                  <div class="h-72 rounded-xl border border-slate-200 bg-slate-50/80"></div>
                </template>
                <template x-if="!loading && !stats.enrollments_by_semester.length">
                  <div class="flex h-72 items-center justify-center rounded-xl border border-dashed border-slate-200 bg-slate-50/80 text-sm text-slate-500">
                    No enrollment activity recorded.
                  </div>
                </template>
                <div x-show="!loading && stats.enrollments_by_semester.length" class="relative h-72" x-cloak>
                  <canvas x-ref="enrollmentCanvas" aria-label="Line chart showing enrollments per semester" role="img"></canvas>
                </div>
              </div>
            </article>
          </section>

          <section class="mt-10 grid gap-6 lg:grid-cols-3">
            <article class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm lg:col-span-2">
              <h3 class="text-lg font-semibold text-slate-900">Advising checklist</h3>
              <ul class="mt-4 space-y-3 text-sm">
                <template x-for="item in checklist" :key="item.title">
                  <li class="flex items-start gap-3 rounded-xl border border-slate-100 bg-slate-50/60 px-4 py-3">
                    <span class="mt-1 inline-flex h-6 w-6 flex-none items-center justify-center rounded-full bg-slate-900 text-xs font-semibold text-white" x-text="item.step"></span>
                    <div>
                      <p class="font-medium text-slate-800" x-text="item.title"></p>
                      <p class="text-slate-500" x-text="item.description"></p>
                    </div>
                  </li>
                </template>
              </ul>
            </article>
            <article class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
              <h3 class="text-lg font-semibold text-slate-900">Quick links</h3>
              <ul class="mt-4 space-y-3 text-sm">
                <template x-for="link in quickLinks" :key="link.href">
                  <li>
                    <a :href="link.href" class="group flex items-center justify-between rounded-xl border border-slate-200 bg-white px-4 py-3 transition hover:border-slate-300 hover:bg-slate-50">
                      <div>
                        <p class="font-medium text-slate-800" x-text="link.title"></p>
                        <p class="text-xs text-slate-500" x-text="link.description"></p>
                      </div>
                      <svg class="h-4 w-4 text-slate-400 transition group-hover:text-slate-900" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5.25 15.75 12 9 18.75" stroke-linecap="round" stroke-linejoin="round" /></svg>
                    </a>
                  </li>
                </template>
              </ul>
            </article>
          </section>
        </div>
      </main>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('dashboardPage', () => ({
        loading: true,
        error: '',
        stats: {
          students_by_major: [],
          enrollments_by_semester: [],
          top_courses_by_enrollment: []
        },
        majorChart: null,
        enrollmentChart: null,
        checklist: [
          { step: 1, title: 'Confirm advising rosters', description: 'Finalize assignments for new transfer students.' },
          { step: 2, title: 'Publish midterm grades', description: 'Grades are due Friday at 5pm for 200-level courses.' },
          { step: 3, title: 'Audit waitlists', description: 'Sections exceeding 95% capacity require approval.' }
        ],
        quickLinks: [
          { title: 'Review student directory', description: 'Search and manage profiles.', href: '/pages/students.html' },
          { title: 'Update course catalog', description: 'Edit credit hours & descriptions.', href: '/pages/courses.html' },
          { title: 'Coordinate sections', description: 'Assign rooms and instructors.', href: '/pages/sections.html' }
        ],
        init() {
          this.fetchStats();
        },
        async fetchStats() {
          this.loading = true;
          this.error = '';
          try {
            const response = await fetch('/api/stats');
            const payload = await response.json().catch(() => null);
            if (!response.ok || !payload || typeof payload !== 'object') {
              const message = (payload && payload.error) || `Request failed with status ${response.status}`;
              throw new Error(message);
            }
            this.stats = {
              students_by_major: Array.isArray(payload.students_by_major) ? payload.students_by_major : [],
              enrollments_by_semester: Array.isArray(payload.enrollments_by_semester) ? payload.enrollments_by_semester : [],
              top_courses_by_enrollment: Array.isArray(payload.top_courses_by_enrollment)
                ? payload.top_courses_by_enrollment
                : []
            };
            this.$nextTick(() => {
              this.renderCharts();
            });
          } catch (error) {
            console.error('Failed to load stats', error);
            this.error = error instanceof Error ? error.message : 'Please refresh and try again.';
            this.destroyCharts();
          } finally {
            this.loading = false;
          }
        },
        get cards() {
          const studentTotal = this.stats.students_by_major.reduce((sum, item) => sum + (Number(item.count) || 0), 0);
          const enrollmentTotal = this.stats.enrollments_by_semester.reduce((sum, item) => sum + (Number(item.count) || 0), 0);
          const semesterCount = this.stats.enrollments_by_semester.length;
          const majorCount = this.stats.students_by_major.length;
          const topCourse = this.stats.top_courses_by_enrollment[0] || null;
          return [
            {
              name: 'Total students',
              value: studentTotal ? this.formatNumber(studentTotal) : '—',
              delta: majorCount ? `${majorCount} major${majorCount === 1 ? '' : 's'} represented` : 'Awaiting roster'
            },
            {
              name: 'Enrollments logged',
              value: enrollmentTotal ? this.formatNumber(enrollmentTotal) : '—',
              delta: semesterCount ? `Across ${semesterCount} semester${semesterCount === 1 ? '' : 's'}` : 'No records yet'
            },
            {
              name: 'Active majors',
              value: majorCount ? this.formatNumber(majorCount) : '—',
              delta: studentTotal ? `${this.formatNumber(Math.round(studentTotal / Math.max(majorCount, 1)))} avg per major` : 'Awaiting data'
            },
            {
              name: 'Top course',
              value: topCourse ? (topCourse.title || topCourse.course_id || '—') : '—',
              delta: topCourse && topCourse.count ? `${this.formatNumber(topCourse.count)} enrolled` : 'No enrollments logged'
            }
          ];
        },
        formatNumber(value) {
          try {
            return new Intl.NumberFormat('en-US').format(Number(value) || 0);
          } catch (error) {
            return String(value);
          }
        },
        destroyCharts() {
          if (this.majorChart) {
            this.majorChart.destroy();
            this.majorChart = null;
          }
          if (this.enrollmentChart) {
            this.enrollmentChart.destroy();
            this.enrollmentChart = null;
          }
        },
        renderCharts() {
          this.renderMajorChart();
          this.renderEnrollmentChart();
        },
        renderMajorChart() {
          const labels = this.stats.students_by_major.map((item) => item.major_dept_id || 'UNKNOWN');
          const data = this.stats.students_by_major.map((item) => Number(item.count) || 0);
          if (!labels.length || !this.$refs.majorCanvas) {
            if (this.majorChart) {
              this.majorChart.destroy();
              this.majorChart = null;
            }
            return;
          }
          if (this.majorChart) {
            this.majorChart.data.labels = labels;
            this.majorChart.data.datasets[0].data = data;
            this.majorChart.update();
            return;
          }
          const ctx = this.$refs.majorCanvas.getContext('2d');
          if (!ctx) return;
          this.majorChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [
                {
                  label: 'Students',
                  data,
                  backgroundColor: '#1e293b'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                x: { ticks: { color: '#475569' } },
                y: {
                  ticks: { color: '#475569' },
                  beginAtZero: true,
                  suggestedMax: Math.max(...data, 5) + 2
                }
              }
            }
          });
        },
        renderEnrollmentChart() {
          const labels = this.stats.enrollments_by_semester.map((item) => item.semester || 'UNKNOWN');
          const data = this.stats.enrollments_by_semester.map((item) => Number(item.count) || 0);
          if (!labels.length || !this.$refs.enrollmentCanvas) {
            if (this.enrollmentChart) {
              this.enrollmentChart.destroy();
              this.enrollmentChart = null;
            }
            return;
          }
          if (this.enrollmentChart) {
            this.enrollmentChart.data.labels = labels;
            this.enrollmentChart.data.datasets[0].data = data;
            this.enrollmentChart.update();
            return;
          }
          const ctx = this.$refs.enrollmentCanvas.getContext('2d');
          if (!ctx) return;
          this.enrollmentChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [
                {
                  label: 'Enrollments',
                  data,
                  fill: false,
                  borderColor: '#0f172a',
                  backgroundColor: '#0f172a',
                  tension: 0.4,
                  pointRadius: 4,
                  pointBackgroundColor: '#f97316'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                x: { ticks: { color: '#475569' } },
                y: { ticks: { color: '#475569' }, beginAtZero: false }
              }
            }
          });
        }
      }));
    });
  </script>
</body>
</html>
