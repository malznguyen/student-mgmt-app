<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enrollments · Student Mgmt</title>
  <link rel="stylesheet" href="../style.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/@alpinejs/focus@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.store('session', {
        isAdmin: localStorage.getItem('is_admin') === 'true',
        setAdmin(value) {
          this.isAdmin = !!value;
          if (value) {
            localStorage.setItem('is_admin', 'true');
          } else {
            localStorage.removeItem('is_admin');
          }
        }
      });
    });

    function layoutShell() {
      return {
        sidebarOpen: false,
        loggingOut: false,
        async logout() {
          if (this.loggingOut) return;
          this.loggingOut = true;
          try {
            await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' });
          } catch (error) {
            console.error('Logout failed', error);
          } finally {
            Alpine.store('session').setAdmin(false);
            window.location.reload();
          }
        }
      };
    }
  </script>
</head>
<body class="min-h-screen bg-slate-100 text-slate-700" x-data="layoutShell()" x-on:keydown.escape.window="sidebarOpen = false">
  <div class="flex min-h-screen">
    <div x-cloak x-show="sidebarOpen" x-transition.opacity class="fixed inset-0 z-30 bg-slate-900/40 md:hidden" aria-hidden="true" @click="sidebarOpen = false"></div>
    <aside x-cloak x-show="sidebarOpen" x-transition:enter="transition transform duration-200" x-transition:enter-start="-translate-x-full" x-transition:enter-end="translate-x-0" x-transition:leave="transition transform duration-200" x-transition:leave-start="translate-x-0" x-transition:leave-end="-translate-x-full" class="fixed inset-y-0 left-0 z-40 w-72 bg-white border-r border-slate-200 md:static md:translate-x-0 md:block">
      <div class="flex items-center gap-3 px-6 h-16 border-b border-slate-100">
        <img src="../assets/logo.svg" alt="Student Management logo" class="h-9 w-9" />
        <div>
          <p class="text-sm uppercase tracking-widest text-slate-400">Student Mgmt</p>
          <p class="text-base font-semibold text-slate-800">Admin Console</p>
        </div>
      </div>
      <nav class="px-4 py-6 space-y-1 text-sm font-medium">
        <a href="/" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M3 9.75 12 3l9 6.75V21a.75.75 0 0 1-.75.75H3.75A.75.75 0 0 1 3 21V9.75Z" /><path d="M9 21v-6h6v6" stroke-linecap="round" /></svg>
          </span>
          Dashboard
        </a>
        <a href="/pages/students.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" /><path d="M4.5 21a7.5 7.5 0 0 1 15 0" stroke-linecap="round" /></svg>
          </span>
          Students
        </a>
        <a href="/pages/courses.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 5.25h15" stroke-linecap="round" /><path d="M6 4.5h12A1.5 1.5 0 0 1 19.5 6v13.5a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1-.75-.75V6A1.5 1.5 0 0 1 6 4.5Z" /><path d="M9 9h6m-6 4.5h6" stroke-linecap="round" /></svg>
          </span>
          Courses
        </a>
        <a href="/pages/sections.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 6.75h15" stroke-linecap="round" /><path d="M4.5 12h15" stroke-linecap="round" /><path d="M4.5 17.25h15" stroke-linecap="round" /></svg>
          </span>
          Sections
        </a>
        <a href="/pages/enrollments.html" aria-current="page" class="flex items-center gap-3 rounded-xl px-3 py-2 bg-slate-900/5 text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-900 text-white">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 4.5h15v15h-15z" /><path d="M8.25 8.25h7.5v7.5h-7.5z" /><path d="M8.25 4.5v3.75M15.75 4.5v3.75M4.5 12h3.75m7.5 0H19.5M8.25 16.5V19.5m7.5-3v3" stroke-linecap="round" /></svg>
          </span>
          Enrollments
        </a>
        <a href="/pages/reports.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 19.5 9 13.5l4.5 3 6-9" stroke-linecap="round" stroke-linejoin="round" /><path d="M3.75 5.25h16.5" stroke-linecap="round" /></svg>
          </span>
          Reports
        </a>
        <template x-if="$store.session.isAdmin">
          <span class="flex items-center gap-3 rounded-xl px-3 py-2 text-emerald-700 bg-emerald-100/80 font-semibold">
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-emerald-600 text-white">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="m5.25 12 3.5 3.5L18.75 5.5" stroke-linecap="round" stroke-linejoin="round" /></svg>
            </span>
            Admin access
          </span>
        </template>
        <template x-if="!$store.session.isAdmin">
          <a href="/pages/login.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900" title="Admin only">
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M9 5.25 15.75 12 9 18.75" stroke-linecap="round" stroke-linejoin="round" /></svg>
            </span>
            Login
          </a>
        </template>
      </nav>
      <div class="mt-auto px-6 py-6 border-t border-slate-100 text-xs text-slate-500">
        <p>Grade submission window <span class="font-semibold text-slate-700">May 8</span></p>
        <p class="mt-1">Incomplete alerts <span class="font-semibold text-slate-700">2</span></p>
      </div>
    </aside>

    <div class="flex-1 flex flex-col min-h-screen">
      <header class="sticky top-0 z-20 border-b border-slate-200 bg-white/95 backdrop-blur">
        <div class="flex items-center justify-between px-4 sm:px-6 h-16">
          <div class="flex items-center gap-3">
            <button type="button" class="inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-600 shadow-sm transition hover:border-slate-300 hover:text-slate-900 md:hidden" @click="sidebarOpen = true" aria-label="Open navigation menu">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 7.5h15M4.5 12h15M4.5 16.5h15" stroke-linecap="round" /></svg>
            </button>
            <div>
              <p class="text-xs uppercase tracking-widest text-slate-400">Records</p>
              <h1 class="text-lg font-semibold text-slate-900">Enrollments</h1>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <nav class="hidden md:flex items-center gap-6 text-sm font-medium text-slate-600">
              <a href="/" class="hover:text-slate-900">Dashboard</a>
              <a href="/pages/students.html" class="hover:text-slate-900">Students</a>
              <a href="/pages/courses.html" class="hover:text-slate-900">Courses</a>
              <a href="/pages/sections.html" class="hover:text-slate-900">Sections</a>
              <a href="/pages/enrollments.html" class="text-slate-900">Enrollments</a>
              <a href="/pages/reports.html" class="hover:text-slate-900">Reports</a>
            </nav>
            <div class="flex items-center gap-3 text-xs sm:text-sm font-semibold text-slate-600">
              <template x-if="$store.session.isAdmin">
                <div class="flex items-center gap-3">
                  <span class="inline-flex items-center gap-2 rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">
                    <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                    Admin
                  </span>
                  <button type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-60" @click="logout" :disabled="loggingOut" :title="loggingOut ? 'Signing out…' : 'Sign out of admin mode'">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M15.75 8.25 19.5 12l-3.75 3.75" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.5 12h-9" stroke-linecap="round" stroke-linejoin="round" /><path d="M12 19.5H6.75A2.25 2.25 0 0 1 4.5 17.25v-10.5A2.25 2.25 0 0 1 6.75 4.5H12" stroke-linecap="round" stroke-linejoin="round" /></svg>
                    <span x-text="loggingOut ? 'Signing out…' : 'Logout'"></span>
                  </button>
                </div>
              </template>
              <template x-if="!$store.session.isAdmin">
                <a href="/pages/login.html" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:text-slate-900" title="Sign in for admin features">
                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M9 5.25 15.75 12 9 18.75" stroke-linecap="round" stroke-linejoin="round" /><path d="M4.5 12h11.25" stroke-linecap="round" stroke-linejoin="round" /></svg>
                  Login
                </a>
              </template>
            </div>
          </div>
        </div>
      </header>

      <main class="flex-1">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10" x-data="enrollmentsPage()">
          <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
            <div>
              <h2 class="text-3xl font-semibold text-slate-900">Enrollment ledger</h2>
              <p class="mt-2 text-slate-600">Monitor performance, identify grade risks, and manage grading deadlines.</p>
            </div>
            <div class="flex flex-wrap gap-3">
              <button type="button" @click="openCreate()" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm hover:border-slate-300 disabled:cursor-not-allowed disabled:opacity-60" :disabled="!$store.session.isAdmin" :title="$store.session.isAdmin ? 'Add enrollment' : 'Admin only'">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 6v12" stroke-linecap="round" /><path d="M6 12h12" stroke-linecap="round" /></svg>
                Add enrollment
              </button>
              <button type="button" class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-smooth">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5.25 15.75 12 9 18.75" stroke-linecap="round" stroke-linejoin="round" /></svg>
                Export grades
              </button>
            </div>
          </div>

          <section class="mt-10 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
            <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
              <div class="w-full md:max-w-sm">
                <label for="enrollment-search" class="text-sm font-medium text-slate-700">Search by ID</label>
                <div class="mt-1 relative">
                  <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="6" /><path d="m17 17 3.5 3.5" stroke-linecap="round" /></svg>
                  </span>
                  <input id="enrollment-search" type="search" x-model="search" placeholder="Search student or section ID" class="w-full rounded-xl border border-slate-200 bg-white py-2 pl-10 pr-3 text-sm text-slate-700 placeholder:text-slate-400 focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" />
                </div>
              </div>
              <div class="flex flex-col gap-4 sm:flex-row">
                <div>
                  <label for="semester-filter" class="text-sm font-medium text-slate-700">Semester</label>
                  <select id="semester-filter" x-model="selectedSemester" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200">
                    <option value="">All semesters</option>
                    <template x-for="semester in semesters" :key="semester">
                      <option x-text="semester"></option>
                    </template>
                  </select>
                </div>
              </div>
            </div>

            <div class="mt-6">
              <div x-cloak x-show="loadError" x-transition class="rounded-xl border border-rose-200 bg-rose-50/80 p-4 text-sm text-rose-700" role="alert">
                <p class="font-medium">Unable to load enrollments.</p>
                <p class="mt-1 text-rose-600" x-text="loadError"></p>
              </div>

              <template x-if="loading">
                <div class="overflow-hidden rounded-2xl border border-slate-200">
                  <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 text-left text-sm table-sticky-header">
                      <thead class="bg-slate-50 text-xs uppercase tracking-wider text-slate-500">
                        <tr>
                          <th scope="col" class="px-4 py-3 font-semibold">Student</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Section</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Semester</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Midterm</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Final</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Bonus</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Letter</th>
                          <th scope="col" class="px-4 py-3 font-semibold text-right">Actions</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-slate-100 bg-white">
                        <template x-for="i in 6" :key="i">
                          <tr>
                            <td class="px-4 py-3"><span class="skeleton-line h-4 w-40 rounded"></span></td>
                            <td class="px-4 py-3"><span class="skeleton-line h-4 w-36 rounded"></span></td>
                            <td class="px-4 py-3"><span class="skeleton-line h-4 w-20 rounded"></span></td>
                            <td class="px-4 py-3"><span class="skeleton-line h-4 w-16 rounded"></span></td>
                            <td class="px-4 py-3"><span class="skeleton-line h-4 w-16 rounded"></span></td>
                            <td class="px-4 py-3"><span class="skeleton-line h-4 w-16 rounded"></span></td>
                            <td class="px-4 py-3"><span class="skeleton-line h-4 w-12 rounded"></span></td>
                            <td class="px-4 py-3 text-right"><span class="skeleton-line h-4 w-24 rounded ml-auto block"></span></td>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </div>
              </template>

              <template x-if="!loading && !loadError && filteredEnrollments.length">
                <div class="overflow-hidden rounded-2xl border border-slate-200">
                  <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 text-left text-sm table-sticky-header">
                      <thead class="bg-slate-50 text-xs uppercase tracking-wider text-slate-500">
                        <tr>
                          <th scope="col" class="px-4 py-3 font-semibold">Student</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Section</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Semester</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Midterm</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Final</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Bonus</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Letter</th>
                          <th scope="col" class="px-4 py-3 font-semibold text-right">Actions</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-slate-100 bg-white">
                        <template x-for="record in filteredEnrollments" :key="record._id">
                          <tr class="hover:bg-slate-50">
                            <td class="px-4 py-3">
                              <div class="font-medium text-slate-900" x-text="record.student_id"></div>
                            </td>
                            <td class="px-4 py-3">
                              <div class="font-medium text-slate-900" x-text="record.section_id"></div>
                            </td>
                            <td class="px-4 py-3">
                              <span class="inline-flex items-center gap-2 rounded-full bg-slate-900/5 px-3 py-1 text-xs font-medium text-slate-700">
                                <span class="h-2 w-2 rounded-full bg-slate-400"></span>
                                <span x-text="record.semester"></span>
                              </span>
                            </td>
                            <td class="px-4 py-3 text-sm text-slate-700" x-text="formatScore(record.midterm)"></td>
                            <td class="px-4 py-3 text-sm text-slate-700" x-text="formatScore(record.final)"></td>
                            <td class="px-4 py-3 text-sm text-slate-700" x-text="formatScore(record.bonus)"></td>
                            <td class="px-4 py-3">
                              <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold" :class="badgeClass(record.letter)">
                                <span x-text="record.letter || '—'"></span>
                                <span class="hidden sm:inline" x-text="letterStatus(record.letter)"></span>
                              </span>
                            </td>
                            <td class="px-4 py-3 text-right">
                              <div class="inline-flex items-center gap-2">
                                <button type="button" @click="openEdit(record)" class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-600 hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-60" :disabled="!$store.session.isAdmin" :title="$store.session.isAdmin ? 'Edit enrollment' : 'Admin only'">
                                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="m4.5 19.5 3.75-.938a2 2 0 0 0 .938-.52l9.02-9.02a1.5 1.5 0 0 0-2.121-2.122l-9.02 9.02a2 2 0 0 0-.52.938L4.5 19.5Z" /><path d="M14.25 6.75 17.25 9.75" /></svg>
                                  Edit
                                </button>
                                <button type="button" @click="deleteEnrollment(record._id)" :disabled="!$store.session.isAdmin || deletingId === record._id" class="inline-flex items-center gap-1 rounded-full border border-transparent px-3 py-1.5 text-xs font-medium text-rose-600 hover:bg-rose-50 disabled:cursor-not-allowed disabled:opacity-60" :title="$store.session.isAdmin ? 'Delete enrollment' : 'Admin only'">
                                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6.75 7.5h10.5" stroke-linecap="round" /><path d="M9 7.5V6a1.5 1.5 0 0 1 1.5-1.5h3A1.5 1.5 0 0 1 15 6v1.5" /><path d="M8.25 7.5V18a1.5 1.5 0 0 0 1.5 1.5h4.5A1.5 1.5 0 0 0 15.75 18V7.5" /></svg>
                                  <span x-text="deletingId === record._id ? 'Removing…' : 'Delete'"></span>
                                </button>
                              </div>
                            </td>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </div>
              </template>

              <template x-if="!loading && !loadError && filteredEnrollments.length === 0">
                <div class="mt-6 flex flex-col items-center justify-center gap-4 rounded-2xl border border-dashed border-slate-200 bg-slate-50/80 py-12 text-center">
                  <span class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-white shadow-sm">
                    <svg class="h-6 w-6 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4.5 4.5h15v15h-15z" /><path d="M8.25 8.25h7.5v7.5h-7.5z" /><path d="M8.25 4.5v3.75M15.75 4.5v3.75M4.5 12h3.75m7.5 0H19.5M8.25 16.5V19.5m7.5-3v3" stroke-linecap="round" /></svg>
                  </span>
                  <div>
                    <h3 class="text-lg font-semibold text-slate-900">No enrollment records</h3>
                    <p class="mt-1 text-sm text-slate-500">Broaden your filters or refresh after instructors submit grades.</p>
                  </div>
                </div>
              </template>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <div x-cloak x-show="toast.visible" x-transition class="fixed top-4 right-4 z-50 w-full max-w-sm rounded-xl border px-4 py-3 shadow-lg" :class="toast.variant === 'success' ? 'border-emerald-200 bg-emerald-50/90 text-emerald-800' : 'border-rose-200 bg-rose-50/90 text-rose-700'" role="status" aria-live="polite">
    <div class="flex items-start gap-3">
      <span class="mt-0.5 inline-flex h-6 w-6 flex-none items-center justify-center rounded-full" :class="toast.variant === 'success' ? 'bg-emerald-600 text-white' : 'bg-rose-600 text-white'">
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <template x-if="toast.variant === 'success'"><path d="M5.25 12.75 9 16.5l9-9" stroke-linecap="round" stroke-linejoin="round" /></template>
          <template x-if="toast.variant !== 'success'"><path d="M15 9 9 15m0-6 6 6" stroke-linecap="round" stroke-linejoin="round" /></template>
        </svg>
      </span>
      <div>
        <p class="text-sm font-semibold" x-text="toast.message"></p>
        <p class="text-xs text-slate-500" x-text="toast.detail"></p>
      </div>
      <button type="button" class="ml-auto text-xs font-medium text-slate-500 hover:text-slate-700" @click="toast.visible = false">Dismiss</button>
    </div>
  </div>

  <div x-cloak x-show="modalOpen" class="fixed inset-0 z-40 flex items-center justify-center px-4 py-6" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-slate-900/40" @click="closeModal()"></div>
    <div class="relative w-full max-w-2xl rounded-2xl border border-slate-200 bg-white p-6 shadow-xl" x-trap.noscroll="modalOpen" x-transition>
      <header class="flex items-start justify-between gap-3">
        <div>
          <p class="text-xs uppercase tracking-widest text-slate-400" x-text="isEditing ? 'Update enrollment' : 'Create enrollment'"></p>
          <h2 class="text-2xl font-semibold text-slate-900" x-text="isEditing ? 'Edit enrollment' : 'Add new enrollment'"></h2>
        </div>
        <button type="button" class="rounded-lg border border-transparent p-2 text-slate-400 hover:text-slate-600" @click="closeModal()" aria-label="Close dialog">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 9l6 6m0-6-6 6" stroke-linecap="round" /></svg>
        </button>
      </header>

      <form class="mt-6 space-y-5" @submit.prevent="saveEnrollment()">
        <div class="grid gap-5 sm:grid-cols-2">
          <div>
            <label for="enrollment-student" class="text-sm font-medium text-slate-700">Student</label>
            <input id="enrollment-student" type="text" x-model="form.student_id" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.student_id ? 'border-rose-300' : 'border-slate-200'" placeholder="e.g. S-2001" required />
            <p x-show="errors.student_id" x-text="errors.student_id" class="mt-1 text-xs font-medium text-rose-600"></p>
          </div>
          <div>
            <label for="enrollment-section" class="text-sm font-medium text-slate-700">Section</label>
            <input id="enrollment-section" type="text" x-model="form.section_id" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.section_id ? 'border-rose-300' : 'border-slate-200'" placeholder="e.g. CS101_2025A_01" required />
            <p x-show="errors.section_id" x-text="errors.section_id" class="mt-1 text-xs font-medium text-rose-600"></p>
          </div>
        </div>

        <div class="grid gap-5 sm:grid-cols-3">
          <div>
            <label for="enrollment-semester" class="text-sm font-medium text-slate-700">Semester</label>
            <input id="enrollment-semester" type="text" x-model="form.semester" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.semester ? 'border-rose-300' : 'border-slate-200'" placeholder="2025A" required />
            <p x-show="errors.semester" x-text="errors.semester" class="mt-1 text-xs font-medium text-rose-600"></p>
          </div>
          <div>
            <label for="enrollment-midterm" class="text-sm font-medium text-slate-700">Midterm</label>
            <input id="enrollment-midterm" type="number" step="0.1" x-model.number="form.midterm" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.midterm ? 'border-rose-300' : 'border-slate-200'" placeholder="e.g. 88" />
            <p x-show="errors.midterm" x-text="errors.midterm" class="mt-1 text-xs font-medium text-rose-600"></p>
          </div>
          <div>
            <label for="enrollment-final" class="text-sm font-medium text-slate-700">Final</label>
            <input id="enrollment-final" type="number" step="0.1" x-model.number="form.final" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.final ? 'border-rose-300' : 'border-slate-200'" placeholder="e.g. 92" />
            <p x-show="errors.final" x-text="errors.final" class="mt-1 text-xs font-medium text-rose-600"></p>
          </div>
        </div>

        <div class="grid gap-5 sm:grid-cols-3">
          <div>
            <label for="enrollment-bonus" class="text-sm font-medium text-slate-700">Bonus</label>
            <input id="enrollment-bonus" type="number" step="0.1" x-model.number="form.bonus" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.bonus ? 'border-rose-300' : 'border-slate-200'" placeholder="Optional" />
            <p x-show="errors.bonus" x-text="errors.bonus" class="mt-1 text-xs font-medium text-rose-600"></p>
          </div>
          <div>
            <label class="text-sm font-medium text-slate-700">Letter grade</label>
            <div class="mt-1 inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm font-medium text-slate-700">
              <span x-text="form.letter || currentGradePreview.letter || '—'"></span>
              <span class="text-xs text-slate-500" x-text="currentGradePreview.letter ? `Preview: ${currentGradePreview.letter} (${currentGradePreview.total})` : 'Preview updates as scores are added.'"></span>
            </div>
          </div>
        </div>

        <div class="flex items-center justify-end gap-3 pt-2">
          <button type="button" class="rounded-full border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 hover:border-slate-300 disabled:opacity-50" @click="closeModal()" :disabled="saving">Cancel</button>
          <button type="submit" class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-smooth disabled:opacity-50" :disabled="saving">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5.25 12.75 9 16.5l9-9" stroke-linecap="round" stroke-linejoin="round" /></svg>
            <span x-text="saving ? 'Saving…' : 'Save enrollment'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('enrollmentsPage', () => ({
        enrollments: [],
        loading: true,
        loadError: '',
        search: '',
        selectedSemester: '',
        modalOpen: false,
        isEditing: false,
        saving: false,
        deletingId: '',
        toastTimeout: null,
        toast: { visible: false, message: '', detail: '', variant: 'success' },
        form: {
          _id: '',
          student_id: '',
          section_id: '',
          semester: '',
          midterm: '',
          final: '',
          bonus: '',
          letter: ''
        },
        errors: {},
        get semesters() {
          return [...new Set(this.enrollments.map((record) => record.semester).filter(Boolean))].sort();
        },
        get filteredEnrollments() {
          const term = this.search.trim().toLowerCase();
          return this.enrollments.filter((record) => {
            const matchesSemester = this.selectedSemester ? record.semester === this.selectedSemester : true;
            const matchesSearch = term
              ? [record.student_id, record.section_id].some((value) =>
                  String(value || '').toLowerCase().includes(term)
                )
              : true;
            return matchesSemester && matchesSearch;
          });
        },
        get currentGradePreview() {
          return this.calculatePreview(this.form.midterm, this.form.final, this.form.bonus);
        },
        init() {
          this.loadData();
        },
        async loadData() {
          this.loading = true;
          this.loadError = '';
          try {
            this.enrollments = await this.requestEnrollments();
          } catch (error) {
            console.error('Failed to load enrollments', error);
            this.enrollments = [];
            this.loadError = error instanceof Error ? error.message : 'Please refresh and try again.';
            this.showToast('Unable to load enrollments.', 'error', 'Check your network connection.');
          } finally {
            this.loading = false;
          }
        },
        async requestEnrollments() {
          const response = await fetch('/api/enrollments');
          const payload = await response.json().catch(() => null);
          if (!response.ok || !Array.isArray(payload)) {
            const message = (payload && payload.error) || `Request failed with status ${response.status}`;
            throw new Error(message);
          }
          return payload.map((record) => ({
            _id: record._id ?? `${record.student_id}:${record.section_id}`,
            student_id: record.student_id ?? '',
            section_id: record.section_id ?? '',
            semester: record.semester ?? '',
            midterm: record.midterm != null ? Number(record.midterm) : null,
            final: record.final != null ? Number(record.final) : null,
            bonus: record.bonus != null ? Number(record.bonus) : null,
            letter: record.letter ?? ''
          }));
        },
        async refreshEnrollments() {
          this.enrollments = await this.requestEnrollments();
        },
        openCreate() {
          if (!Alpine.store('session').isAdmin) {
            this.showToast('Admin only', 'error', 'Sign in as admin to manage enrollments.');
            return;
          }
          this.isEditing = false;
          this.form = {
            _id: '',
            student_id: '',
            section_id: '',
            semester: '',
            midterm: '',
            final: '',
            bonus: '',
            letter: ''
          };
          this.errors = {};
          this.saving = false;
          this.modalOpen = true;
        },
        openEdit(record) {
          if (!Alpine.store('session').isAdmin) {
            this.showToast('Admin only', 'error', 'Sign in as admin to manage enrollments.');
            return;
          }
          this.isEditing = true;
          this.form = {
            _id: record._id,
            student_id: record.student_id,
            section_id: record.section_id,
            semester: record.semester,
            midterm: record.midterm == null ? '' : Number(record.midterm),
            final: record.final == null ? '' : Number(record.final),
            bonus: record.bonus == null ? '' : Number(record.bonus),
            letter: record.letter || ''
          };
          this.errors = {};
          this.saving = false;
          this.modalOpen = true;
        },
        closeModal() {
          if (this.saving) return;
          this.modalOpen = false;
          this.form = {
            _id: '',
            student_id: '',
            section_id: '',
            semester: '',
            midterm: '',
            final: '',
            bonus: '',
            letter: ''
          };
          this.errors = {};
        },
        validate() {
          const nextErrors = {};
          if (!this.form.student_id.trim()) nextErrors.student_id = 'Student ID is required.';
          if (!this.form.section_id.trim()) nextErrors.section_id = 'Section ID is required.';
          if (!this.form.semester.trim()) nextErrors.semester = 'Semester is required.';
          const numericFields = [
            { key: 'midterm', min: 0, max: 10, label: 'Midterm' },
            { key: 'final', min: 0, max: 10, label: 'Final' },
            { key: 'bonus', min: 0, max: 2, label: 'Bonus' }
          ];
          numericFields.forEach(({ key, min, max, label }) => {
            const value = this.form[key];
            if (value === '' || value === null || value === undefined) return;
            const numberValue = Number(value);
            if (Number.isNaN(numberValue)) {
              nextErrors[key] = `${label} must be a number.`;
            } else if (numberValue < min || numberValue > max) {
              nextErrors[key] = `${label} must be between ${min} and ${max}.`;
            }
          });
          this.errors = nextErrors;
          return Object.keys(nextErrors).length === 0;
        },
        buildPayload() {
          const sanitizeNumber = (value) => (value === '' || value === null || value === undefined ? null : Number(value));
          return {
            student_id: this.form.student_id.trim(),
            section_id: this.form.section_id.trim(),
            semester: this.form.semester.trim().toUpperCase(),
            midterm: sanitizeNumber(this.form.midterm),
            final: sanitizeNumber(this.form.final),
            bonus: sanitizeNumber(this.form.bonus)
          };
        },
        async saveEnrollment() {
          if (!Alpine.store('session').isAdmin) {
            this.showToast('Admin only', 'error', 'Sign in as admin to manage enrollments.');
            return;
          }
          if (!this.validate()) {
            this.showToast('Please review the highlighted fields.', 'error', 'Missing required information.');
            return;
          }

          this.saving = true;
          const payload = this.buildPayload();
          const method = this.isEditing ? 'PUT' : 'POST';
          const url = this.isEditing
            ? `/api/enrollments/${encodeURIComponent(this.form._id)}`
            : '/api/enrollments';
          const preview = this.calculatePreview(payload.midterm, payload.final, payload.bonus);

          try {
            const response = await fetch(url, {
              method,
              headers: { 'Content-Type': 'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify(payload)
            });
            const result = await response.json().catch(() => null);

            if (response.status === 403 || (result && result.error === 'forbidden')) {
              this.showToast('Admin only', 'error', 'Sign in as admin to manage enrollments.');
              return;
            }

            if (!response.ok || !result || result.error) {
              this.errors = (result && result.details) || {};
              const detailMessage =
                this.errors.student_id ||
                this.errors.section_id ||
                this.errors.semester ||
                (result && result.error) ||
                '';
              this.showToast((result && result.error) || 'Unable to save enrollment.', 'error', detailMessage);
              return;
            }

            await this.refreshEnrollments();
            this.closeModal();
            const detail = preview.letter ? `Preview letter: ${preview.letter} (${preview.total})` : '';
            this.showToast(this.isEditing ? 'Enrollment updated.' : 'Enrollment created.', 'success', detail);
          } catch (error) {
            console.error('Failed to save enrollment', error);
            this.showToast('Unable to save enrollment.', 'error', 'Check your network connection.');
          } finally {
            this.saving = false;
          }
        },
        async deleteEnrollment(id) {
          if (!Alpine.store('session').isAdmin) {
            this.showToast('Admin only', 'error', 'Sign in as admin to manage enrollments.');
            return;
          }
          if (!window.confirm('Remove this enrollment record?')) {
            return;
          }

          this.deletingId = id;
          try {
            const response = await fetch(`/api/enrollments/${encodeURIComponent(id)}`, {
              method: 'DELETE',
              credentials: 'same-origin'
            });
            const result = await response.json().catch(() => null);

            if (response.status === 403 || (result && result.error === 'forbidden')) {
              this.showToast('Admin only', 'error', 'Sign in as admin to manage enrollments.');
              return;
            }

            if (!response.ok || !result || !result.ok) {
              this.showToast(
                (result && result.error) || 'Unable to delete enrollment.',
                'error',
                'Please try again in a moment.'
              );
              return;
            }

            this.enrollments = this.enrollments.filter((record) => record._id !== id);
            this.showToast('Enrollment deleted.', 'success', 'Record removed from the roster.');
          } catch (error) {
            console.error('Failed to delete enrollment', error);
            this.showToast('Unable to delete enrollment.', 'error', 'Check your network connection.');
          } finally {
            this.deletingId = '';
          }
        },
        badgeClass(letter) {
          if (!letter) return 'bg-slate-100 text-slate-700';
          if (letter === 'F') return 'bg-rose-100 text-rose-700';
          if (letter.startsWith('A')) return 'bg-emerald-100 text-emerald-700';
          if (letter.startsWith('B')) return 'bg-sky-100 text-sky-700';
          return 'bg-amber-100 text-amber-800';
        },
        letterStatus(letter) {
          if (!letter) return 'Pending';
          if (letter.startsWith('A')) return 'Strong performance';
          if (letter.startsWith('B')) return 'On track';
          if (letter === 'F') return 'At risk';
          return 'Monitor closely';
        },
        formatScore(value) {
          if (value === '' || value === null || Number.isNaN(value)) return '—';
          const numberValue = Number(value);
          return numberValue.toFixed(2).replace(/\.?0+$/, '');
        },
        calculatePreview(midterm, final, bonus) {
          const mid = midterm === '' || midterm === null || midterm === undefined ? null : Number(midterm);
          const fin = final === '' || final === null || final === undefined ? null : Number(final);
          const extra = bonus === '' || bonus === null || bonus === undefined ? 0 : Number(bonus);
          if (mid === null || fin === null || Number.isNaN(mid) || Number.isNaN(fin)) {
            return { letter: '', total: null };
          }
          let total = 0.4 * mid + 0.6 * fin + (Number.isNaN(extra) ? 0 : extra);
          total = Math.max(0, Math.min(total, 10));
          total = Math.round(total * 100) / 100;
          let letter = '';
          if (total >= 8.5) letter = 'A';
          else if (total >= 8.0) letter = 'A-';
          else if (total >= 7.5) letter = 'B+';
          else if (total >= 7.0) letter = 'B';
          else if (total >= 6.5) letter = 'B-';
          else if (total >= 6.0) letter = 'C+';
          else if (total >= 5.5) letter = 'C';
          else if (total >= 5.0) letter = 'D';
          else letter = 'F';
          const displayTotal = total.toFixed(2).replace(/\.?0+$/, '');
          return { letter, total: displayTotal };
        },
        showToast(message, variant = 'success', detail = '') {
          if (this.toastTimeout) {
            clearTimeout(this.toastTimeout);
          }
          this.toast = { visible: true, message, variant, detail };
          this.toastTimeout = setTimeout(() => {
            this.toast.visible = false;
          }, 3200);
        }
      }));
    });
  </script>
</body>
</html>
