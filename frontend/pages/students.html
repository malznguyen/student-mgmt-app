<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Students · Student Mgmt</title>
  <link rel="stylesheet" href="../style.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/@alpinejs/focus@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script>
    const SESSION_CACHE_KEY = 'session_cache_v1';

    function createSessionStore() {
      let cached = null;
      try {
        const raw = localStorage.getItem(SESSION_CACHE_KEY);
        cached = raw ? JSON.parse(raw) : null;
      } catch (error) {
        console.warn('Unable to parse cached session.', error);
      }

      return {
        user: cached && typeof cached === 'object' ? cached.user || null : null,
        isAdmin: cached && typeof cached === 'object' ? !!cached.isAdmin : false,
        setFromUser(user) {
          this.user = user || null;
          this.isAdmin = !!(user && user.role === 'admin');
          this.persist();
        },
        setFromServer(isAdmin) {
          this.isAdmin = !!isAdmin;
          if (!this.isAdmin) {
            this.user = null;
          }
          this.persist();
        },
        reset() {
          this.user = null;
          this.isAdmin = false;
          this.persist();
        },
        persist() {
          try {
            if (this.user || this.isAdmin) {
              localStorage.setItem(
                SESSION_CACHE_KEY,
                JSON.stringify({ user: this.user, isAdmin: this.isAdmin })
              );
            } else {
              localStorage.removeItem(SESSION_CACHE_KEY);
            }
          } catch (error) {
            console.warn('Unable to persist session cache.', error);
          }
        }
      };
    }

    async function refreshSessionFromServer(store) {
      try {
        const response = await fetch('/api/me', { credentials: 'same-origin' });
        if (!response.ok) {
          throw new Error('Failed to fetch session');
        }
        const data = await response.json();
        store.setFromServer(Boolean(data && data.is_admin));
      } catch (error) {
        console.error('Unable to refresh session state.', error);
        store.setFromServer(false);
      }
    }

    document.addEventListener('alpine:init', () => {
      const sessionStore = createSessionStore();
      Alpine.store('session', sessionStore);
      refreshSessionFromServer(sessionStore);
    });

    function layoutShell() {
      return {
        sidebarOpen: false,
        loggingOut: false,
        async logout() {
          if (this.loggingOut) return;
          this.loggingOut = true;
          const sessionStore = Alpine.store('session');
          try {
            await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' });
          } catch (error) {
            console.error('Logout failed', error);
          } finally {
            sessionStore.reset();
            await refreshSessionFromServer(sessionStore);
            window.location.reload();
          }
        }
      };
    }
  </script>
</head>
<body class="min-h-screen bg-slate-100 text-slate-700" x-data="layoutShell()" x-on:keydown.escape.window="sidebarOpen = false">
  <div class="flex min-h-screen">
    <div x-cloak x-show="sidebarOpen" x-transition.opacity class="fixed inset-0 z-30 bg-slate-900/40 md:hidden" aria-hidden="true" @click="sidebarOpen = false"></div>
    <aside x-cloak x-show="sidebarOpen" x-transition:enter="transition transform duration-200" x-transition:enter-start="-translate-x-full" x-transition:enter-end="translate-x-0" x-transition:leave="transition transform duration-200" x-transition:leave-start="translate-x-0" x-transition:leave-end="-translate-x-full" class="fixed inset-y-0 left-0 z-40 w-72 bg-white border-r border-slate-200 md:static md:translate-x-0 md:block">
      <div class="flex items-center gap-3 px-6 h-16 border-b border-slate-100">
        <img src="../assets/logo.svg" alt="Student Management logo" class="h-9 w-9" />
        <div>
          <p class="text-sm uppercase tracking-widest text-slate-400">Student Mgmt</p>
          <p class="text-base font-semibold text-slate-800">Admin Console</p>
        </div>
      </div>
      <nav class="px-4 py-6 space-y-1 text-sm font-medium">
        <a href="/" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M3 9.75 12 3l9 6.75V21a.75.75 0 0 1-.75.75H3.75A.75.75 0 0 1 3 21V9.75Z" /><path d="M9 21v-6h6v6" stroke-linecap="round" /></svg>
          </span>
          Dashboard
        </a>
        <a href="/pages/students.html" aria-current="page" class="flex items-center gap-3 rounded-xl px-3 py-2 bg-slate-900/5 text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-900 text-white">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" /><path d="M4.5 21a7.5 7.5 0 0 1 15 0" stroke-linecap="round" /></svg>
          </span>
          Students
        </a>
        <a href="/pages/courses.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 5.25h15" stroke-linecap="round" /><path d="M6 4.5h12A1.5 1.5 0 0 1 19.5 6v13.5a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1-.75-.75V6A1.5 1.5 0 0 1 6 4.5Z" /><path d="M9 9h6m-6 4.5h6" stroke-linecap="round" /></svg>
          </span>
          Courses
        </a>
        <a href="/pages/sections.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 6.75h15" stroke-linecap="round" /><path d="M4.5 12h15" stroke-linecap="round" /><path d="M4.5 17.25h15" stroke-linecap="round" /></svg>
          </span>
          Sections
        </a>
        <a href="/pages/enrollments.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 4.5h15v15h-15z" /><path d="M8.25 8.25h7.5v7.5h-7.5z" /><path d="M8.25 4.5v3.75M15.75 4.5v3.75M4.5 12h3.75m7.5 0H19.5M8.25 16.5V19.5m7.5-3v3" stroke-linecap="round" /></svg>
          </span>
          Enrollments
        </a>
        <a href="/pages/reports.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 19.5 9 13.5l4.5 3 6-9" stroke-linecap="round" stroke-linejoin="round" /><path d="M3.75 5.25h16.5" stroke-linecap="round" /></svg>
          </span>
          Reports
        </a>
        <template x-if="$store.session.isAdmin">
          <span class="flex items-center gap-3 rounded-xl px-3 py-2 text-emerald-700 bg-emerald-100/80 font-semibold">
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-emerald-600 text-white">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="m5.25 12 3.5 3.5L18.75 5.5" stroke-linecap="round" stroke-linejoin="round" /></svg>
            </span>
            Admin access
          </span>
        </template>
        <template x-if="!$store.session.isAdmin">
          <a href="/pages/login.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900" title="Admin only">
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M9 5.25 15.75 12 9 18.75" stroke-linecap="round" stroke-linejoin="round" /></svg>
            </span>
            Login
          </a>
        </template>
      </nav>
      <div class="mt-auto px-6 py-6 border-t border-slate-100 text-xs text-slate-500">
        <p>Academic year <span class="font-semibold text-slate-700">2025</span></p>
        <p class="mt-1">Admissions freeze <span class="font-semibold text-slate-700">in 4 days</span></p>
      </div>
    </aside>

    <div class="flex-1 flex flex-col min-h-screen">
      <header class="sticky top-0 z-20 border-b border-slate-200 bg-white/95 backdrop-blur">
        <div class="flex items-center justify-between px-4 sm:px-6 h-16">
          <div class="flex items-center gap-3">
            <button type="button" class="inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-600 shadow-sm transition hover:border-slate-300 hover:text-slate-900 md:hidden" @click="sidebarOpen = true" aria-label="Open navigation menu">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 7.5h15M4.5 12h15M4.5 16.5h15" stroke-linecap="round" /></svg>
            </button>
            <div>
              <p class="text-xs uppercase tracking-widest text-slate-400">Directory</p>
              <h1 class="text-lg font-semibold text-slate-900">Students</h1>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <nav class="hidden md:flex items-center gap-6 text-sm font-medium text-slate-600">
              <a href="/" class="hover:text-slate-900">Dashboard</a>
              <a href="/pages/students.html" class="text-slate-900">Students</a>
              <a href="/pages/courses.html" class="hover:text-slate-900">Courses</a>
              <a href="/pages/sections.html" class="hover:text-slate-900">Sections</a>
              <a href="/pages/enrollments.html" class="hover:text-slate-900">Enrollments</a>
              <a href="/pages/reports.html" class="hover:text-slate-900">Reports</a>
            </nav>
            <div class="flex items-center gap-3 text-xs sm:text-sm font-semibold text-slate-600">
              <template x-if="$store.session.isAdmin">
                <div class="flex items-center gap-3">
                  <span class="inline-flex items-center gap-2 rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">
                    <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                    Admin
                  </span>
                  <button type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-60" @click="logout" :disabled="loggingOut" :title="loggingOut ? 'Signing out…' : 'Sign out of admin mode'">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M15.75 8.25 19.5 12l-3.75 3.75" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.5 12h-9" stroke-linecap="round" stroke-linejoin="round" /><path d="M12 19.5H6.75A2.25 2.25 0 0 1 4.5 17.25v-10.5A2.25 2.25 0 0 1 6.75 4.5H12" stroke-linecap="round" stroke-linejoin="round" /></svg>
                    <span x-text="loggingOut ? 'Signing out…' : 'Logout'"></span>
                  </button>
                </div>
              </template>
              <template x-if="!$store.session.isAdmin">
                <a href="/pages/login.html" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:text-slate-900" title="Sign in for admin features">
                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M9 5.25 15.75 12 9 18.75" stroke-linecap="round" stroke-linejoin="round" /><path d="M4.5 12h11.25" stroke-linecap="round" stroke-linejoin="round" /></svg>
                  Login
                </a>
              </template>
            </div>
          </div>
        </div>
      </header>

      <main class="flex-1">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10" x-data="studentsPage" x-on:keydown.escape.window="modalOpen ? closeModal() : null">
          <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
            <div>
              <h2 class="text-3xl font-semibold text-slate-900">Student roster</h2>
              <p class="mt-2 text-slate-600">Search, add, and manage student profiles for the current academic cycle.</p>
            </div>
            <div class="flex flex-wrap gap-3">
              <button
                type="button"
                @click="openCreate()"
                :disabled="!$store.session.isAdmin"
                :title="$store.session.isAdmin ? 'Add a new student' : 'Admin access required'"
                class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-smooth disabled:cursor-not-allowed disabled:opacity-60"
              >
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M12 6v12m6-6H6" stroke-linecap="round" /></svg>
                Add student
              </button>
              <button type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm hover:border-slate-300">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M5.25 7.5h13.5" stroke-linecap="round" /><path d="M5.25 12h13.5" stroke-linecap="round" /><path d="M5.25 16.5h13.5" stroke-linecap="round" /></svg>
                Export CSV
              </button>
            </div>
          </div>

          <section class="mt-10 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm" aria-labelledby="student-search">
            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
              <div class="flex-1">
                <p class="text-sm font-medium text-slate-700">Server-side filters keep the roster fast.</p>
                <p class="mt-1 text-xs text-slate-500">Use the toolbar below to search, sort, and narrow the student list.</p>
              </div>
              <div class="grid grid-cols-2 gap-3 text-xs text-slate-500 sm:flex sm:flex-col sm:text-right">
                <div>
                  <p class="font-semibold text-slate-900" x-text="hasLoaded ? formatNumber(total) : '—'"></p>
                  <p>Total students</p>
                </div>
                <div>
                  <p class="font-semibold text-slate-900" x-text="hasLoaded ? formatNumber(classYears) : '—'"></p>
                  <p>Class years on this page</p>
                </div>
              </div>
            </div>

            <div class="mt-6 rounded-2xl border border-slate-200 bg-slate-50/70 p-4">
              <div class="grid gap-3 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5">
                <div class="md:col-span-2 xl:col-span-2">
                  <label id="student-search" for="student-search-input" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Search roster</label>
                  <div class="relative mt-1">
                    <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400">
                      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><circle cx="11" cy="11" r="6" /><path d="m17 17 3.5 3.5" stroke-linecap="round" /></svg>
                    </span>
                    <input id="student-search-input" type="search" placeholder="Search by name or email" x-model.debounce.400ms="query" @input.debounce.400ms="handleFilterChange(true)" :disabled="loading" class="w-full rounded-xl border border-slate-200 bg-white py-2 pl-10 pr-3 text-sm text-slate-700 placeholder:text-slate-400 focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200 disabled:cursor-not-allowed disabled:bg-slate-100" />
                  </div>
                </div>
                <div>
                  <label for="filter-major" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Major</label>
                  <select id="filter-major" x-model="selectedMajor" @change="handleFilterChange(true)" :disabled="loading" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200 disabled:cursor-not-allowed disabled:bg-slate-100">
                    <template x-for="option in majorFilterOptions" :key="option.value || 'all'">
                      <option :value="option.value" x-text="option.label"></option>
                    </template>
                  </select>
                </div>
                <div>
                  <label for="filter-year" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Class year</label>
                  <select id="filter-year" x-model="selectedYear" @change="handleFilterChange(true)" :disabled="loading" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200 disabled:cursor-not-allowed disabled:bg-slate-100">
                    <template x-for="option in yearFilterOptions" :key="option.value || 'all'">
                      <option :value="option.value" x-text="option.label"></option>
                    </template>
                  </select>
                </div>
                <div>
                  <label for="sort-by" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Sort</label>
                  <select id="sort-by" x-model="sort" @change="handleFilterChange(true)" :disabled="loading" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200 disabled:cursor-not-allowed disabled:bg-slate-100">
                    <template x-for="option in sortOptions" :key="option.value">
                      <option :value="option.value" x-text="option.label"></option>
                    </template>
                  </select>
                </div>
              </div>
              <div class="mt-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <p class="text-xs font-medium text-slate-600" aria-live="polite" x-text="hasLoaded ? rangeSummary() : '—'"></p>
                <div class="flex flex-wrap items-center gap-3 text-xs font-medium text-slate-600">
                  <label for="page-size" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Page size</label>
                  <select id="page-size" x-model.number="pageSize" @change="handlePageSizeChange()" :disabled="loading" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200 disabled:cursor-not-allowed disabled:bg-slate-100">
                    <template x-for="size in pageSizeOptions" :key="`page-size-${size}`">
                      <option :value="size" x-text="size"></option>
                    </template>
                  </select>
                </div>
                <div class="flex items-center gap-2">
                  <button type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-medium text-slate-600 transition hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-60" @click="goToPrev()" :disabled="loading || !hasPrev">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="m14.25 6.75-4.5 4.5 4.5 4.5" stroke-linecap="round" stroke-linejoin="round" /></svg>
                    <span>Prev</span>
                  </button>
                  <button type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-medium text-slate-600 transition hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-60" @click="goToNext()" :disabled="loading || !hasNext">
                    <span>Next</span>
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="m9.75 6.75 4.5 4.5-4.5 4.5" stroke-linecap="round" stroke-linejoin="round" /></svg>
                  </button>
                </div>
              </div>
            </div>

            <div x-cloak x-show="loadError" x-transition class="mt-6 rounded-xl border border-rose-200 bg-rose-50/80 p-4 text-sm text-rose-700" role="alert">
              <p class="font-medium">Unable to load students.</p>
              <p class="mt-1 text-rose-600" x-text="loadError"></p>
            </div>

            <div class="relative mt-6">
              <template x-if="loading">
                <div class="space-y-3">
                  <template x-for="i in 5" :key="i">
                    <div class="rounded-xl border border-slate-100 bg-slate-50/70 p-4">
                      <div class="flex items-center justify-between">
                        <div class="flex flex-col gap-2">
                          <span class="skeleton-line h-4 w-40 rounded"></span>
                          <span class="skeleton-line h-3 w-56 rounded"></span>
                        </div>
                        <span class="skeleton-line h-6 w-16 rounded"></span>
                      </div>
                    </div>
                  </template>
                </div>
              </template>

              <template x-if="!loading && hasLoaded && !loadError && students.length === 0">
                <div class="flex flex-col items-center justify-center gap-4 rounded-2xl border border-dashed border-slate-200 bg-slate-50/80 py-12 text-center">
                  <span class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-white shadow-sm">
                    <svg class="h-6 w-6 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M16.5 10.5a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0Z" /><path d="M8.25 15.75a6.75 6.75 0 0 0 7.5 0" stroke-linecap="round" /><path d="M5.25 5.25 3 7.5m18-2.25-2.25 2.25" stroke-linecap="round" /></svg>
                  </span>
                  <div>
                    <h3 class="text-lg font-semibold text-slate-900">No students match your search</h3>
                    <p class="mt-1 text-sm text-slate-500">Try adjusting your filters or add a new student to the roster.</p>
                  </div>
                  <button
                    type="button"
                    @click="openCreate()"
                    :disabled="!$store.session.isAdmin"
                    :title="$store.session.isAdmin ? 'Add a new student' : 'Admin access required'"
                    class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-smooth disabled:cursor-not-allowed disabled:opacity-60"
                  >
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 6v12m6-6H6" stroke-linecap="round" /></svg>
                    Add first student
                  </button>
                </div>
              </template>

              <div x-cloak x-show="!loading && hasLoaded && students.length" class="overflow-hidden rounded-2xl border border-slate-200">
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-slate-200 text-left text-sm table-sticky-header">
                    <thead class="bg-slate-50 text-xs uppercase tracking-wider text-slate-500">
                      <tr>
                        <th scope="col" class="px-4 py-3 font-semibold">ID</th>
                        <th scope="col" class="px-4 py-3 font-semibold">Full name</th>
                        <th scope="col" class="px-4 py-3 font-semibold">Email</th>
                        <th scope="col" class="px-4 py-3 font-semibold">Phone</th>
                        <th scope="col" class="px-4 py-3 font-semibold">Major</th>
                        <th scope="col" class="px-4 py-3 font-semibold">Year</th>
                        <th scope="col" class="px-4 py-3 font-semibold text-right">Actions</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 bg-white">
                      <template x-for="student in students" :key="student._id">
                        <tr class="hover:bg-slate-50">
                          <td class="px-4 py-3 font-mono text-xs text-slate-500" x-text="student._id"></td>
                          <td class="px-4 py-3">
                            <div class="font-medium text-slate-900" x-text="student.full_name"></div>
                            <p class="text-xs text-slate-500" x-text="student.pronouns"></p>
                          </td>
                          <td class="px-4 py-3">
                            <a :href="`mailto:${student.email}`" class="text-sm text-slate-700 hover:text-slate-900" x-text="student.email"></a>
                          </td>
                          <td class="px-4 py-3 text-sm text-slate-600" x-text="student.phone || '—'"></td>
                          <td class="px-4 py-3">
                            <span class="inline-flex items-center gap-2 rounded-full bg-slate-900/5 px-3 py-1 text-xs font-medium text-slate-700">
                              <span class="h-2 w-2 rounded-full bg-slate-400"></span>
                              <span x-text="departmentMap[student.major_dept_id] || student.major_dept_id"></span>
                            </span>
                          </td>
                          <td class="px-4 py-3 text-sm text-slate-700" x-text="student.year ?? '—'"></td>
                          <td class="px-4 py-3 text-right">
                            <div class="inline-flex items-center gap-2">
                              <button
                                type="button"
                                @click="openEdit(student)"
                                :disabled="!$store.session.isAdmin"
                                :title="$store.session.isAdmin ? 'Edit student' : 'Admin access required'"
                                class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-600 hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-60"
                              >
                                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="m4.5 19.5 3.75-.938a2 2 0 0 0 .938-.52l9.02-9.02a1.5 1.5 0 0 0-2.121-2.122l-9.02 9.02a2 2 0 0 0-.52.938L4.5 19.5Z" /><path d="M14.25 6.75 17.25 9.75" /></svg>
                                Edit
                              </button>
                              <button
                                type="button"
                                @click="deleteStudent(student._id)"
                                :disabled="!$store.session.isAdmin"
                                :title="$store.session.isAdmin ? 'Delete student' : 'Admin access required'"
                                class="inline-flex items-center gap-1 rounded-full border border-transparent px-3 py-1.5 text-xs font-medium text-rose-600 transition hover:bg-rose-50 disabled:cursor-not-allowed disabled:opacity-60"
                              >
                                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6.75 7.5h10.5" stroke-linecap="round" /><path d="M9 7.5V6a1.5 1.5 0 0 1 1.5-1.5h3A1.5 1.5 0 0 1 15 6v1.5" /><path d="M8.25 7.5V18a1.5 1.5 0 0 0 1.5 1.5h4.5A1.5 1.5 0 0 0 15.75 18V7.5" /></svg>
                                <span x-text="deletingId === student._id ? 'Removing…' : 'Delete'"></span>
                              </button>
                            </div>
                          </td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>
        </div>

        <div x-cloak x-show="toast.visible" x-transition class="fixed top-4 right-4 z-50 w-full max-w-sm rounded-xl border px-4 py-3 shadow-lg" :class="toast.variant === 'success' ? 'border-emerald-200 bg-emerald-50/90 text-emerald-800' : 'border-rose-200 bg-rose-50/90 text-rose-700'" role="status" aria-live="polite">
          <div class="flex items-start gap-3">
            <span class="mt-0.5 inline-flex h-6 w-6 flex-none items-center justify-center rounded-full" :class="toast.variant === 'success' ? 'bg-emerald-600 text-white' : 'bg-rose-600 text-white'">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><template x-if="toast.variant === 'success'"><path d="M5.25 12.75 9 16.5l9-9" stroke-linecap="round" stroke-linejoin="round" /></template><template x-if="toast.variant !== 'success'"><path d="M15 9 9 15m0-6 6 6" stroke-linecap="round" stroke-linejoin="round" /></template></svg>
            </span>
            <div>
              <p class="text-sm font-semibold" x-text="toast.message"></p>
              <p class="text-xs text-slate-500" x-text="toast.detail"></p>
            </div>
            <button type="button" class="ml-auto text-xs font-medium text-slate-500 hover:text-slate-700" @click="dismissToast()">Dismiss</button>
          </div>
        </div>

        <div x-cloak x-show="modalOpen" class="fixed inset-0 z-40 flex items-center justify-center px-4 py-6" role="dialog" aria-modal="true">
          <div class="absolute inset-0 bg-slate-900/40" @click="closeModal()"></div>
          <div class="relative w-full max-w-xl rounded-2xl border border-slate-200 bg-white p-6 shadow-xl" x-trap.noscroll="modalOpen" x-transition>
            <header class="flex items-start justify-between gap-3">
              <div>
                <p class="text-xs uppercase tracking-widest text-slate-400" x-text="isEditing ? 'Update student' : 'Create student'"></p>
                <h2 class="text-2xl font-semibold text-slate-900" x-text="isEditing ? 'Edit student' : 'Add new student'"></h2>
              </div>
              <button type="button" class="rounded-lg border border-transparent p-2 text-slate-400 hover:text-slate-600" @click="closeModal()" aria-label="Close dialog">
                <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 9l6 6m0-6-6 6" stroke-linecap="round" /></svg>
              </button>
            </header>
            <form class="mt-6 space-y-4" @submit.prevent="saveStudent()">
              <div>
                <label for="student-id" class="text-sm font-medium text-slate-700">Student ID</label>
                <input id="student-id" type="text" x-model="form._id" :disabled="isEditing" class="mt-1 w-full rounded-xl border px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200 disabled:cursor-not-allowed disabled:bg-slate-100 disabled:text-slate-500" :class="errors._id ? 'border-rose-300' : 'border-slate-200'" placeholder="e.g. S-1101" required />
                <p class="mt-1 text-xs text-slate-500">Use the institutional identifier students receive upon enrollment.</p>
                <p x-show="errors._id" x-text="errors._id" class="mt-1 text-xs font-medium text-rose-600"></p>
              </div>
              <div>
                <label for="student-name" class="text-sm font-medium text-slate-700">Full name</label>
                <input id="student-name" type="text" x-model="form.full_name" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.full_name ? 'border-rose-300' : 'border-slate-200'" placeholder="e.g. Jordan Rivers" required />
                <p class="mt-1 text-xs text-slate-500">Legal display name used on transcripts.</p>
                <p x-show="errors.full_name" x-text="errors.full_name" class="mt-1 text-xs font-medium text-rose-600"></p>
              </div>
              <div>
                <label for="student-email" class="text-sm font-medium text-slate-700">Email address</label>
                <input id="student-email" type="email" x-model="form.email" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.email ? 'border-rose-300' : 'border-slate-200'" placeholder="name@example.edu" required />
                <p class="mt-1 text-xs text-slate-500">Institution-issued email only.</p>
                <p x-show="errors.email" x-text="errors.email" class="mt-1 text-xs font-medium text-rose-600"></p>
              </div>
              <div>
                <label for="student-phone" class="text-sm font-medium text-slate-700">Phone <span class="text-slate-400">(optional)</span></label>
                <input id="student-phone" type="tel" x-model="form.phone" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.phone ? 'border-rose-300' : 'border-slate-200'" placeholder="e.g. (555) 123-4567" inputmode="tel" />
                <p class="mt-1 text-xs text-slate-500">Shared with advising and emergency contacts teams.</p>
                <p x-show="errors.phone" x-text="errors.phone" class="mt-1 text-xs font-medium text-rose-600"></p>
              </div>
              <div class="grid gap-4 sm:grid-cols-2">
                <div>
                  <label for="student-major" class="text-sm font-medium text-slate-700">Major department</label>
                  <select id="student-major" x-model="form.major_dept_id" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.major_dept_id ? 'border-rose-300' : 'border-slate-200'" required>
                    <option value="" disabled>Select department</option>
                    <template x-for="dept in departments" :key="dept.id">
                      <option :value="dept.id" x-text="`${dept.name} (${dept.id})`"></option>
                    </template>
                  </select>
                  <p class="mt-1 text-xs text-slate-500">Students may have multiple majors; select the primary.</p>
                  <p x-show="errors.major_dept_id" x-text="errors.major_dept_id" class="mt-1 text-xs font-medium text-rose-600"></p>
                </div>
                <div>
                  <label for="student-year" class="text-sm font-medium text-slate-700">Grad year</label>
                  <select id="student-year" x-model="form.year" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.year ? 'border-rose-300' : 'border-slate-200'" required>
                    <option value="" disabled>Select year</option>
                    <template x-for="year in yearOptions" :key="year">
                      <option x-text="year"></option>
                    </template>
                  </select>
                  <p class="mt-1 text-xs text-slate-500">Graduation year projected by the registrar.</p>
                  <p x-show="errors.year" x-text="errors.year" class="mt-1 text-xs font-medium text-rose-600"></p>
                </div>
              </div>
              <div>
                <label for="student-pronouns" class="text-sm font-medium text-slate-700">Pronouns <span class="text-slate-400">(optional)</span></label>
                <input id="student-pronouns" type="text" x-model="form.pronouns" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" placeholder="e.g. she/her" />
                <p class="mt-1 text-xs text-slate-500">Shared with advisors and faculty rosters.</p>
              </div>
              <div class="flex items-center justify-end gap-3 pt-4">
                <button type="button" class="rounded-full border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 hover:border-slate-300" @click="closeModal()">Cancel</button>
                <button
                  type="submit"
                  :disabled="saving || !$store.session.isAdmin"
                  :title="$store.session.isAdmin ? (saving ? 'Saving…' : 'Save student') : 'Admin access required'"
                  class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-smooth transition disabled:cursor-not-allowed disabled:opacity-60"
                >
                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5.25 12.75 9 16.5l9-9" stroke-linecap="round" stroke-linejoin="round" /></svg>
                  <span x-text="saving ? 'Saving…' : 'Save student'"></span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    const departmentOptions = [
      { id: 'CS', name: 'Computer Science' },
      { id: 'MATH', name: 'Mathematics' },
      { id: 'BIO', name: 'Biology' },
      { id: 'PHYS', name: 'Physics' },
      { id: 'ECON', name: 'Economics' },
      { id: 'BUS', name: 'Business Administration' }
    ];

    const years = ['2024', '2025', '2026', '2027', '2028', '2029'];
    const numberFormatter = new Intl.NumberFormat();

    document.addEventListener('alpine:init', () => {
      Alpine.data('studentsPage', () => ({
        query: '',
        selectedMajor: '',
        selectedYear: '',
        sort: 'full_name',
        page: 1,
        pageSize: 10,
        total: 0,
        hasNext: false,
        hasPrev: false,
        loading: true,
        loadError: '',
        students: [],
        hasLoaded: false,
        modalOpen: false,
        isEditing: false,
        saving: false,
        deletingId: '',
        toastTimeout: null,
        form: { _id: '', full_name: '', email: '', major_dept_id: '', year: '', pronouns: '', phone: '' },
        errors: {},
        toast: { visible: false, message: '', detail: '', variant: 'success' },
        departments: departmentOptions,
        yearOptions: years,
        pageSizeOptions: [10, 25, 50],
        sortOptions: [
          { value: 'full_name', label: 'Name A → Z' },
          { value: '-full_name', label: 'Name Z → A' },
          { value: 'year', label: 'Grad year ↑' },
          { value: '-year', label: 'Grad year ↓' }
        ],
        majorFilterOptions: [{ value: '', label: 'All majors' }],
        yearFilterOptions: [{ value: '', label: 'All years' }],
        ensureAdmin(detail = 'Sign in to manage students.') {
          if (Alpine.store('session').isAdmin) {
            return true;
          }
          this.showToast('Admin access required', 'error', detail);
          return false;
        },
        get departmentMap() {
          return this.departments.reduce((acc, dept) => ({ ...acc, [dept.id]: dept.name }), {});
        },
        get classYears() {
          return new Set(this.students.map((student) => student.year).filter(Boolean)).size;
        },
        get rangeStart() {
          if (!this.total || !this.students.length) return 0;
          return (this.page - 1) * this.pageSize + 1;
        },
        get rangeEnd() {
          if (!this.total || !this.students.length) return 0;
          return this.rangeStart + this.students.length - 1;
        },
        init() {
          this.initFromUrl();
          this.fetchStudents();
        },
        blankForm() {
          return { _id: '', full_name: '', email: '', major_dept_id: '', year: '', pronouns: '', phone: '' };
        },
        initFromUrl() {
          const params = new URLSearchParams(window.location.search);
          const qParam = params.get('q');
          const majorParam = params.get('major');
          const yearParam = params.get('year');
          const sortParam = params.get('sort');
          const pageParam = params.get('page');
          const pageSizeParam = params.get('page_size');

          if (qParam) this.query = qParam;
          if (majorParam) this.selectedMajor = majorParam;
          if (yearParam) this.selectedYear = yearParam;
          if (sortParam && this.sortOptions.some((option) => option.value === sortParam)) {
            this.sort = sortParam;
          }

          const parsedPage = Number.parseInt(pageParam || '', 10);
          if (Number.isInteger(parsedPage) && parsedPage > 0) {
            this.page = parsedPage;
          }

          const parsedPageSize = Number.parseInt(pageSizeParam || '', 10);
          if (this.pageSizeOptions.includes(parsedPageSize)) {
            this.pageSize = parsedPageSize;
          }
        },
        buildRequestParams() {
          const params = new URLSearchParams();
          params.set('page', String(this.page));
          params.set('page_size', String(this.pageSize));
          params.set('sort', this.sort);
          const trimmedQuery = this.query.trim();
          if (trimmedQuery) params.set('q', trimmedQuery);
          if (this.selectedMajor) params.set('major', this.selectedMajor);
          if (this.selectedYear) params.set('year', this.selectedYear);
          return params;
        },
        buildHistoryParams() {
          const params = new URLSearchParams();
          const trimmedQuery = this.query.trim();
          if (trimmedQuery) params.set('q', trimmedQuery);
          if (this.selectedMajor) params.set('major', this.selectedMajor);
          if (this.selectedYear) params.set('year', this.selectedYear);
          if (this.sort !== 'full_name') params.set('sort', this.sort);
          if (this.page > 1) params.set('page', String(this.page));
          if (this.pageSize !== 10) params.set('page_size', String(this.pageSize));
          return params;
        },
        updateUrl() {
          const params = this.buildHistoryParams();
          const nextUrl = params.toString()
            ? `${window.location.pathname}?${params.toString()}`
            : window.location.pathname;
          window.history.replaceState({}, '', nextUrl);
        },
        composeMajorOptions(majorsSet) {
          const values = new Set(majorsSet);
          if (this.selectedMajor) {
            values.add(this.selectedMajor);
          }
          const options = Array.from(values)
            .filter((value) => value)
            .map((value) => ({ value, label: this.departmentMap[value] || value }))
            .sort((a, b) => a.label.localeCompare(b.label));
          return [{ value: '', label: 'All majors' }, ...options];
        },
        composeYearOptions(yearsSet) {
          const values = new Set(yearsSet);
          const selectedYearNumber = Number.parseInt(this.selectedYear || '', 10);
          if (!Number.isNaN(selectedYearNumber)) {
            values.add(selectedYearNumber);
          }
          const options = Array.from(values)
            .filter((value) => Number.isInteger(value))
            .sort((a, b) => a - b)
            .map((value) => ({ value: String(value), label: String(value) }));
          return [{ value: '', label: 'All years' }, ...options];
        },
        async fetchStudents() {
          this.loading = true;
          this.loadError = '';
          try {
            const params = this.buildRequestParams();
            const response = await fetch(`/api/students?${params.toString()}`);
            const payload = await response.json().catch(() => null);
            if (
              !response.ok ||
              !payload ||
              !Array.isArray(payload.items)
            ) {
              const message = (payload && payload.error) || `Request failed with status ${response.status}`;
              throw new Error(message);
            }

            const majorsSet = new Set();
            const yearsSet = new Set();

            this.students = payload.items.map((student) => {
              const majorId = student.major_dept_id ?? '';
              if (majorId) majorsSet.add(majorId);

              let yearValue = null;
              if (typeof student.year === 'number' && Number.isInteger(student.year)) {
                yearValue = student.year;
              } else if (typeof student.year === 'string' && student.year.trim()) {
                const parsedYear = Number.parseInt(student.year, 10);
                if (Number.isInteger(parsedYear)) {
                  yearValue = parsedYear;
                }
              }
              if (Number.isInteger(yearValue)) {
                yearsSet.add(yearValue);
              }

              return {
                _id: student._id ?? '',
                full_name: student.full_name ?? '',
                email: student.email ?? '',
                major_dept_id: majorId,
                year: Number.isInteger(yearValue) ? yearValue : null,
                pronouns: student.pronouns ?? '',
                phone: student.phone ?? ''
              };
            });

            const responsePage = Number.parseInt(payload.page, 10);
            if (Number.isInteger(responsePage) && responsePage > 0) {
              this.page = responsePage;
            }

            const responsePageSize = Number.parseInt(payload.page_size, 10);
            if (Number.isInteger(responsePageSize) && responsePageSize > 0) {
              this.pageSize = responsePageSize;
            }

            this.total = Number.isInteger(payload.total) ? payload.total : 0;
            this.hasNext = Boolean(payload.has_next);
            this.hasPrev = Boolean(payload.has_prev);

            this.majorFilterOptions = this.composeMajorOptions(majorsSet);
            this.yearFilterOptions = this.composeYearOptions(yearsSet);

            if (!this.students.length) {
              // Ensure filter dropdowns still offer active selections even when empty
              if (!majorsSet.size) {
                this.majorFilterOptions = this.composeMajorOptions(new Set());
              }
              if (!yearsSet.size) {
                this.yearFilterOptions = this.composeYearOptions(new Set());
              }
            }

            this.hasLoaded = true;
            this.updateUrl();
          } catch (error) {
            console.error('Failed to load students', error);
            this.students = [];
            this.total = 0;
            this.hasNext = false;
            this.hasPrev = false;
            this.majorFilterOptions = this.composeMajorOptions(new Set());
            this.yearFilterOptions = this.composeYearOptions(new Set());
            this.loadError = error instanceof Error ? error.message : 'Please refresh and try again.';
            this.showToast('Unable to load students.', 'error', 'Please refresh or try again later.');
          } finally {
            this.loading = false;
            if (!this.hasLoaded) {
              this.hasLoaded = true;
            }
          }
        },
        handleFilterChange(resetPage = false) {
          if (resetPage) {
            this.page = 1;
          }
          this.fetchStudents();
        },
        handlePageSizeChange() {
          this.page = 1;
          this.fetchStudents();
        },
        goToPrev() {
          if (this.loading || !this.hasPrev) return;
          this.page = Math.max(1, this.page - 1);
          this.fetchStudents();
        },
        goToNext() {
          if (this.loading || !this.hasNext) return;
          this.page = this.page + 1;
          this.fetchStudents();
        },
        formatNumber(value) {
          return numberFormatter.format(Math.max(0, value || 0));
        },
        rangeSummary() {
          const start = this.rangeStart;
          const end = this.rangeEnd;
          const total = this.total;
          if (!total) {
            return '0–0 of 0';
          }
          return `${this.formatNumber(start)}–${this.formatNumber(end)} of ${this.formatNumber(total)}`;
        },
        openCreate() {
          if (!this.ensureAdmin()) {
            return;
          }
          this.isEditing = false;
          this.form = this.blankForm();
          this.errors = {};
          this.saving = false;
          this.modalOpen = true;
        },
        openEdit(student) {
          if (!this.ensureAdmin()) {
            return;
          }
          this.isEditing = true;
          this.form = {
            _id: student._id,
            full_name: student.full_name,
            email: student.email,
            major_dept_id: student.major_dept_id,
            year: student.year != null ? String(student.year) : '',
            pronouns: student.pronouns || '',
            phone: student.phone || ''
          };
          this.errors = {};
          this.saving = false;
          this.modalOpen = true;
        },
        closeModal() {
          this.modalOpen = false;
          this.form = this.blankForm();
          this.errors = {};
          this.saving = false;
        },
        validate() {
          const nextErrors = {};
          if (!this.form._id.trim()) nextErrors._id = 'Student ID is required.';
          if (!this.form.full_name.trim()) nextErrors.full_name = 'Full name is required.';
          if (!this.form.email.trim()) {
            nextErrors.email = 'Email is required.';
          } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.form.email)) {
            nextErrors.email = 'Enter a valid email address.';
          }
          if (!this.form.major_dept_id) nextErrors.major_dept_id = 'Select a primary department.';
          if (!this.form.year) nextErrors.year = 'Choose an expected graduation year.';
          if (this.form.phone && !/^[+\d()\s-]{7,}$/.test(this.form.phone)) {
            nextErrors.phone = 'Enter a valid phone number.';
          }
          this.errors = nextErrors;
          return Object.keys(nextErrors).length === 0;
        },
        async saveStudent() {
          if (!this.ensureAdmin('Sign in to modify student records.')) {
            return;
          }
          if (!this.validate()) {
            this.showToast('Please fix the highlighted fields.', 'error', 'Missing required information.');
            return;
          }

          this.saving = true;
          this.errors = {};

          const payload = {
            _id: this.form._id.trim(),
            full_name: this.form.full_name.trim(),
            email: this.form.email.trim(),
            major_dept_id: this.form.major_dept_id,
            year: Number.parseInt(this.form.year, 10),
            pronouns: this.form.pronouns.trim(),
            phone: this.form.phone.trim()
          };

          if (!payload.pronouns) {
            delete payload.pronouns;
          }
          if (!payload.phone) {
            delete payload.phone;
          }

          const method = this.isEditing ? 'PUT' : 'POST';
          const url = this.isEditing
            ? `/api/students/${encodeURIComponent(this.form._id)}`
            : '/api/students';

          if (this.isEditing) {
            delete payload._id;
          }

          try {
            const response = await fetch(url, {
              method,
              headers: { 'Content-Type': 'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify(payload)
            });
            const result = await response.json().catch(() => null);

            if (!response.ok || !result || result.ok !== true) {
              const details = (result && result.details) || {};
              this.errors = details;
              const detailMessage =
                details.email ||
                details._id ||
                Object.values(details)[0] ||
                (result && result.error === 'forbidden'
                  ? 'Please try again later.'
                  : '');
              const message =
                result && result.error === 'forbidden'
                  ? 'Unable to save student.'
                  : (result && result.error) || 'Unable to save student.';
              this.showToast(message, 'error', detailMessage);
              return;
            }

            await this.fetchStudents();
            this.closeModal();
            this.showToast(
              this.isEditing ? 'Updated' : 'Created',
              'success',
              this.isEditing ? 'Student record saved.' : 'Student added to roster.'
            );
          } catch (error) {
            console.error('Failed to save student', error);
            this.showToast('Unable to save student.', 'error', 'Check your network connection.');
          } finally {
            this.saving = false;
          }
        },
        async deleteStudent(id) {
          if (!this.ensureAdmin('Sign in to modify student records.')) {
            return;
          }
          if (!window.confirm('Remove this student from the roster?')) {
            return;
          }

          this.deletingId = id;

          try {
            const response = await fetch(`/api/students/${encodeURIComponent(id)}`, {
              method: 'DELETE',
              credentials: 'same-origin'
            });
            const result = await response.json().catch(() => null);

            if (!response.ok || !result || result.ok !== true) {
              const message =
                result && result.error === 'forbidden'
                  ? 'Unable to delete student.'
                  : (result && result.error) || 'Unable to delete student.';
              const detail =
                result && result.error === 'forbidden'
                  ? 'Please try again later.'
                  : 'Please try again in a moment.';
              this.showToast(message, 'error', detail);
              return;
            }

            await this.fetchStudents();
            this.showToast('Deleted', 'success', 'The roster now reflects this change.');
          } catch (error) {
            console.error('Failed to delete student', error);
            this.showToast('Unable to delete student.', 'error', 'Check your network connection.');
          } finally {
            this.deletingId = '';
          }
        },
        showToast(message, variant = 'success', detail = '') {
          if (this.toastTimeout) {
            clearTimeout(this.toastTimeout);
          }
          this.toast = { visible: true, message, variant, detail };
          this.toastTimeout = setTimeout(() => {
            this.toast.visible = false;
            this.toastTimeout = null;
          }, 3400);
        },
        dismissToast() {
          if (this.toastTimeout) {
            clearTimeout(this.toastTimeout);
            this.toastTimeout = null;
          }
          this.toast.visible = false;
        }
      }));
    });
  </script>
</body>
</html>
