<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sections Â· Student Mgmt</title>
  <link rel="stylesheet" href="../style.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/@alpinejs/focus@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.store('session', {
        isAdmin: localStorage.getItem('is_admin') === 'true',
        setAdmin(value) {
          this.isAdmin = !!value;
          if (value) {
            localStorage.setItem('is_admin', 'true');
          } else {
            localStorage.removeItem('is_admin');
          }
        }
      });
    });

    function layoutShell() {
      return {
        sidebarOpen: false,
        loggingOut: false,
        async logout() {
          if (this.loggingOut) return;
          this.loggingOut = true;
          try {
            await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' });
          } catch (error) {
            console.error('Logout failed', error);
          } finally {
            Alpine.store('session').setAdmin(false);
            window.location.reload();
          }
        }
      };
    }
  </script>
</head>
<body class="min-h-screen bg-slate-100 text-slate-700" x-data="layoutShell()" x-on:keydown.escape.window="sidebarOpen = false">
  <div class="flex min-h-screen">
    <div x-cloak x-show="sidebarOpen" x-transition.opacity class="fixed inset-0 z-30 bg-slate-900/40 md:hidden" aria-hidden="true" @click="sidebarOpen = false"></div>
    <aside x-cloak x-show="sidebarOpen" x-transition:enter="transition transform duration-200" x-transition:enter-start="-translate-x-full" x-transition:enter-end="translate-x-0" x-transition:leave="transition transform duration-200" x-transition:leave-start="translate-x-0" x-transition:leave-end="-translate-x-full" class="fixed inset-y-0 left-0 z-40 w-72 bg-white border-r border-slate-200 md:static md:translate-x-0 md:block">
      <div class="flex items-center gap-3 px-6 h-16 border-b border-slate-100">
        <img src="../assets/logo.svg" alt="Student Management logo" class="h-9 w-9" />
        <div>
          <p class="text-sm uppercase tracking-widest text-slate-400">Student Mgmt</p>
          <p class="text-base font-semibold text-slate-800">Admin Console</p>
        </div>
      </div>
      <nav class="px-4 py-6 space-y-1 text-sm font-medium">
        <a href="/" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M3 9.75 12 3l9 6.75V21a.75.75 0 0 1-.75.75H3.75A.75.75 0 0 1 3 21V9.75Z" /><path d="M9 21v-6h6v6" stroke-linecap="round" /></svg>
          </span>
          Dashboard
        </a>
        <a href="/pages/students.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" /><path d="M4.5 21a7.5 7.5 0 0 1 15 0" stroke-linecap="round" /></svg>
          </span>
          Students
        </a>
        <a href="/pages/courses.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 5.25h15" stroke-linecap="round" /><path d="M6 4.5h12A1.5 1.5 0 0 1 19.5 6v13.5a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1-.75-.75V6A1.5 1.5 0 0 1 6 4.5Z" /><path d="M9 9h6m-6 4.5h6" stroke-linecap="round" /></svg>
          </span>
          Courses
        </a>
        <a href="/pages/sections.html" aria-current="page" class="flex items-center gap-3 rounded-xl px-3 py-2 bg-slate-900/5 text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-900 text-white">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 6.75h15" stroke-linecap="round" /><path d="M4.5 12h15" stroke-linecap="round" /><path d="M4.5 17.25h15" stroke-linecap="round" /></svg>
          </span>
          Sections
        </a>
        <a href="/pages/enrollments.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 4.5h15v15h-15z" /><path d="M8.25 8.25h7.5v7.5h-7.5z" /><path d="M8.25 4.5v3.75M15.75 4.5v3.75M4.5 12h3.75m7.5 0H19.5M8.25 16.5V19.5m7.5-3v3" stroke-linecap="round" /></svg>
          </span>
          Enrollments
        </a>
        <a href="/pages/reports.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 19.5 9 13.5l4.5 3 6-9" stroke-linecap="round" stroke-linejoin="round" /><path d="M3.75 5.25h16.5" stroke-linecap="round" /></svg>
          </span>
          Reports
        </a>
        <template x-if="$store.session.isAdmin">
          <span class="flex items-center gap-3 rounded-xl px-3 py-2 text-emerald-700 bg-emerald-100/80 font-semibold">
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-emerald-600 text-white">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="m5.25 12 3.5 3.5L18.75 5.5" stroke-linecap="round" stroke-linejoin="round" /></svg>
            </span>
            Admin access
          </span>
        </template>
        <template x-if="!$store.session.isAdmin">
          <a href="/pages/login.html" class="flex items-center gap-3 rounded-xl px-3 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900" title="Admin only">
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M9 5.25 15.75 12 9 18.75" stroke-linecap="round" stroke-linejoin="round" /></svg>
            </span>
            Login
          </a>
        </template>
      </nav>
      <div class="mt-auto px-6 py-6 border-t border-slate-100 text-xs text-slate-500">
        <p>Room audit <span class="font-semibold text-slate-700">due May 3</span></p>
        <p class="mt-1">Seats available <span class="font-semibold text-slate-700">148</span></p>
      </div>
    </aside>

    <div class="flex-1 flex flex-col min-h-screen">
      <header class="sticky top-0 z-20 border-b border-slate-200 bg-white/95 backdrop-blur">
        <div class="flex items-center justify-between px-4 sm:px-6 h-16">
          <div class="flex items-center gap-3">
            <button type="button" class="inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-600 shadow-sm transition hover:border-slate-300 hover:text-slate-900 md:hidden" @click="sidebarOpen = true" aria-label="Open navigation menu">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M4.5 7.5h15M4.5 12h15M4.5 16.5h15" stroke-linecap="round" /></svg>
            </button>
            <div>
              <p class="text-xs uppercase tracking-widest text-slate-400">Scheduling</p>
              <h1 class="text-lg font-semibold text-slate-900">Sections</h1>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <nav class="hidden md:flex items-center gap-6 text-sm font-medium text-slate-600">
              <a href="/" class="hover:text-slate-900">Dashboard</a>
              <a href="/pages/students.html" class="hover:text-slate-900">Students</a>
              <a href="/pages/courses.html" class="hover:text-slate-900">Courses</a>
              <a href="/pages/sections.html" class="text-slate-900">Sections</a>
              <a href="/pages/enrollments.html" class="hover:text-slate-900">Enrollments</a>
              <a href="/pages/reports.html" class="hover:text-slate-900">Reports</a>
            </nav>
            <div class="flex items-center gap-3 text-xs sm:text-sm font-semibold text-slate-600">
              <template x-if="$store.session.isAdmin">
                <div class="flex items-center gap-3">
                  <span class="inline-flex items-center gap-2 rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">
                    <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                    Admin
                  </span>
                  <button type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:text-slate-900 disabled:cursor-not-allowed disabled:opacity-60" @click="logout" :disabled="loggingOut" :title="loggingOut ? 'Signing outâ¦' : 'Sign out of admin mode'">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M15.75 8.25 19.5 12l-3.75 3.75" stroke-linecap="round" stroke-linejoin="round" /><path d="M19.5 12h-9" stroke-linecap="round" stroke-linejoin="round" /><path d="M12 19.5H6.75A2.25 2.25 0 0 1 4.5 17.25v-10.5A2.25 2.25 0 0 1 6.75 4.5H12" stroke-linecap="round" stroke-linejoin="round" /></svg>
                    <span x-text="loggingOut ? 'Signing outâ¦' : 'Logout'"></span>
                  </button>
                </div>
              </template>
              <template x-if="!$store.session.isAdmin">
                <a href="/pages/login.html" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:text-slate-900" title="Sign in for admin features">
                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M9 5.25 15.75 12 9 18.75" stroke-linecap="round" stroke-linejoin="round" /><path d="M4.5 12h11.25" stroke-linecap="round" stroke-linejoin="round" /></svg>
                  Login
                </a>
              </template>
            </div>
          </div>
        </div>
      </header>

      <main class="flex-1">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10" x-data="sectionsPage()">
          <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
            <div>
              <h2 class="text-3xl font-semibold text-slate-900">Class sections</h2>
              <p class="mt-2 text-slate-600">Coordinate offerings across semesters, instructors, and available rooms.</p>
            </div>
            <div class="flex flex-wrap gap-3">
              <button type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm hover:border-slate-300">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5.25 7.5h13.5" stroke-linecap="round" /><path d="M5.25 12h13.5" stroke-linecap="round" /><path d="M5.25 16.5h13.5" stroke-linecap="round" /></svg>
                Export plan
              </button>
              <button type="button" @click="openCreate()" class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-smooth">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 6v12m6-6H6" stroke-linecap="round" /></svg>
                New section
              </button>
            </div>
          </div>

          <section class="mt-10 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
            <div class="grid gap-4 md:grid-cols-3">
              <div class="md:col-span-2">
                <label for="section-search-filter" class="text-sm font-medium text-slate-700">Search</label>
                <div class="mt-1 relative">
                  <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="6" /><path d="m17 17 3.5 3.5" stroke-linecap="round" /></svg>
                  </span>
                  <input id="section-search-filter" type="search" x-model="searchTerm" placeholder="Search by section or course ID" class="w-full rounded-xl border border-slate-200 bg-white py-2 pl-10 pr-3 text-sm text-slate-700 placeholder:text-slate-400 focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" />
                </div>
                <p class="mt-2 text-xs text-slate-500">Filter sections by matching the section identifier or related course code.</p>
              </div>
              <div>
                <label for="semester-filter" class="text-sm font-medium text-slate-700">Semester</label>
                <select id="semester-filter" x-model="selectedSemester" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200">
                  <option value="">All semesters</option>
                  <template x-for="semester in semesters" :key="semester">
                    <option :value="semester" x-text="semester"></option>
                  </template>
                </select>
              </div>
            </div>

            <div class="mt-6">
              <div x-cloak x-show="loadError" x-transition class="rounded-xl border border-rose-200 bg-rose-50/80 p-4 text-sm text-rose-700" role="alert">
                <p class="font-medium">Unable to load sections.</p>
                <p class="mt-1 text-rose-600" x-text="loadError"></p>
              </div>

              <template x-if="loading">
                <div class="overflow-hidden rounded-2xl border border-slate-200">
                  <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 text-left text-sm table-sticky-header">
                      <thead class="bg-slate-50 text-xs uppercase tracking-wider text-slate-500">
                        <tr>
                          <th scope="col" class="px-4 py-3 font-semibold">Section</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Course</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Semester</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Instructor</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Capacity</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Room</th>
                          <th scope="col" class="px-4 py-3 font-semibold text-right">Actions</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-slate-100 bg-white">
                        <template x-for="i in 5" :key="i">
                          <tr>
                            <td class="px-4 py-3"><span class="skeleton-line h-4 w-24 rounded"></span></td>
                            <td class="px-4 py-3"><span class="skeleton-line h-4 w-40 rounded"></span></td>
                            <td class="px-4 py-3"><span class="skeleton-line h-4 w-20 rounded"></span></td>
                            <td class="px-4 py-3"><span class="skeleton-line h-4 w-32 rounded"></span></td>
                            <td class="px-4 py-3"><span class="skeleton-line h-4 w-16 rounded"></span></td>
                            <td class="px-4 py-3"><span class="skeleton-line h-4 w-20 rounded"></span></td>
                            <td class="px-4 py-3 text-right"><span class="skeleton-line h-4 w-24 rounded ml-auto block"></span></td>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </div>
              </template>

              <template x-if="!loading && !loadError && filteredSections.length">
                <div class="overflow-hidden rounded-2xl border border-slate-200">
                  <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 text-left text-sm table-sticky-header">
                      <thead class="bg-slate-50 text-xs uppercase tracking-wider text-slate-500">
                        <tr>
                          <th scope="col" class="px-4 py-3 font-semibold">Section</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Course</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Semester</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Instructor</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Capacity</th>
                          <th scope="col" class="px-4 py-3 font-semibold">Room</th>
                          <th scope="col" class="px-4 py-3 font-semibold text-right">Actions</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-slate-100 bg-white">
                        <template x-for="section in filteredSections" :key="section._id">
                          <tr class="hover:bg-slate-50">
                            <td class="px-4 py-3">
                              <div class="font-mono text-xs font-medium text-slate-600" x-text="section._id"></div>
                              <p class="text-xs text-slate-500" x-show="section.section_no" x-text="`Sec ${section.section_no}`"></p>
                            </td>
                            <td class="px-4 py-3">
                              <div class="font-medium text-slate-900" x-text="section.course_title || courseMap[section.course_id] || section.course_id"></div>
                              <p class="text-xs text-slate-500" x-text="section.course_id"></p>
                            </td>
                            <td class="px-4 py-3">
                              <span class="inline-flex items-center gap-2 rounded-full bg-slate-900/5 px-3 py-1 text-xs font-medium text-slate-700">
                                <span class="h-2 w-2 rounded-full bg-slate-400"></span>
                                <span x-text="section.semester"></span>
                              </span>
                            </td>
                            <td class="px-4 py-3">
                              <span class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1 text-xs font-medium text-slate-700 shadow-sm">
                                <svg class="h-3.5 w-3.5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" /><path d="M4.5 21a7.5 7.5 0 0 1 15 0" stroke-linecap="round" /></svg>
                                <span x-text="section.instructor_id || 'â'"></span>
                              </span>
                            </td>
                            <td class="px-4 py-3 text-sm text-slate-700">
                              <div class="font-semibold" x-text="section.capacity != null ? section.capacity : 'â'"></div>
                            </td>
                            <td class="px-4 py-3 text-sm text-slate-700">
                              <div x-text="section.room || 'â'"></div>
                              <template x-if="section.schedule && section.schedule.length">
                                <ul class="mt-1 space-y-0.5 text-xs text-slate-500">
                                  <template x-for="(meeting, idx) in section.schedule" :key="`${section._id}-schedule-${idx}`">
                                    <li x-text="formatMeeting(meeting)"></li>
                                  </template>
                                </ul>
                              </template>
                            </td>
                            <td class="px-4 py-3 text-right">
                              <div class="inline-flex items-center gap-2">
                                <button type="button" @click="openEdit(section)" class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-600 hover:border-slate-300 hover:text-slate-900">
                                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="m4.5 19.5 3.75-.938a2 2 0 0 0 .938-.52l9.02-9.02a1.5 1.5 0 0 0-2.121-2.122l-9.02 9.02a2 2 0 0 0-.52.938L4.5 19.5Z" /><path d="M14.25 6.75 17.25 9.75" /></svg>
                                  Edit
                                </button>
                                <button type="button" @click="deleteSection(section._id)" class="inline-flex items-center gap-1 rounded-full border border-transparent px-3 py-1.5 text-xs font-medium text-rose-600 hover:bg-rose-50">
                                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6.75 7.5h10.5" stroke-linecap="round" /><path d="M9 7.5V6a1.5 1.5 0 0 1 1.5-1.5h3A1.5 1.5 0 0 1 15 6v1.5" /><path d="M8.25 7.5V18a1.5 1.5 0 0 0 1.5 1.5h4.5A1.5 1.5 0 0 0 15.75 18V7.5" /></svg>
                                  <span x-text="deletingId === section._id ? 'Removingâ¦' : 'Delete'"></span>
                                </button>
                              </div>
                            </td>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </div>
              </template>

              <template x-if="!loading && !loadError && filteredSections.length === 0">
                <div class="mt-6 flex flex-col items-center justify-center gap-4 rounded-2xl border border-dashed border-slate-200 bg-slate-50/80 py-12 text-center">
                  <span class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-white shadow-sm">
                    <svg class="h-6 w-6 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M7.5 4.5h9L21 12l-4.5 7.5h-9L3 12 7.5 4.5Z" /><path d="M12 9v6" stroke-linecap="round" /><path d="M9 12h6" stroke-linecap="round" /></svg>
                  </span>
                  <div>
                    <h3 class="text-lg font-semibold text-slate-900">No sections scheduled</h3>
                    <p class="mt-1 text-sm text-slate-500">Adjust filters or create a new section to fill the gap.</p>
                  </div>
                </div>
              </template>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <div x-cloak x-show="toast.visible" x-transition class="fixed top-4 right-4 z-50 w-full max-w-sm rounded-xl border px-4 py-3 shadow-lg" :class="toast.variant === 'success' ? 'border-emerald-200 bg-emerald-50/90 text-emerald-800' : 'border-rose-200 bg-rose-50/90 text-rose-700'" role="status" aria-live="polite">
    <div class="flex items-start gap-3">
      <span class="mt-0.5 inline-flex h-6 w-6 flex-none items-center justify-center rounded-full" :class="toast.variant === 'success' ? 'bg-emerald-600 text-white' : 'bg-rose-600 text-white'">
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <template x-if="toast.variant === 'success'"><path d="M5.25 12.75 9 16.5l9-9" stroke-linecap="round" stroke-linejoin="round" /></template>
          <template x-if="toast.variant !== 'success'"><path d="M15 9 9 15m0-6 6 6" stroke-linecap="round" stroke-linejoin="round" /></template>
        </svg>
      </span>
      <div>
        <p class="text-sm font-semibold" x-text="toast.message"></p>
        <p class="text-xs text-slate-500" x-text="toast.detail"></p>
      </div>
      <button type="button" class="ml-auto text-xs font-medium text-slate-500 hover:text-slate-700" @click="toast.visible = false">Dismiss</button>
    </div>
  </div>

  <div x-cloak x-show="modalOpen" class="fixed inset-0 z-40 flex items-center justify-center px-4 py-6" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-slate-900/40" @click="closeModal()"></div>
    <div class="relative w-full max-w-2xl rounded-2xl border border-slate-200 bg-white p-6 shadow-xl" x-trap.noscroll="modalOpen" x-transition>
      <header class="flex items-start justify-between gap-3">
        <div>
          <p class="text-xs uppercase tracking-widest text-slate-400" x-text="isEditing ? 'Update section' : 'Create section'"></p>
          <h2 class="text-2xl font-semibold text-slate-900" x-text="isEditing ? 'Edit section' : 'Add new section'"></h2>
        </div>
        <button type="button" class="rounded-lg border border-transparent p-2 text-slate-400 hover:text-slate-600" @click="closeModal()" aria-label="Close dialog">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 9l6 6m0-6-6 6" stroke-linecap="round" /></svg>
        </button>
      </header>

      <form class="mt-6 space-y-5" @submit.prevent="saveSection()">
        <div class="grid gap-5 sm:grid-cols-2">
          <div>
            <label for="section-id" class="text-sm font-medium text-slate-700">Section ID</label>
            <input id="section-id" type="text" x-model="form._id" :disabled="isEditing" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200 disabled:bg-slate-50" :class="errors._id ? 'border-rose-300' : 'border-slate-200'" placeholder="e.g. SEC-CS101-2025A-01" required />
            <p class="mt-1 text-xs text-slate-500">Use the registrar-friendly identifier.</p>
            <p x-show="errors._id" x-text="errors._id" class="mt-1 text-xs font-medium text-rose-600"></p>
          </div>
          <div>
            <label for="section-course" class="text-sm font-medium text-slate-700">Course</label>
            <select id="section-course" x-model="form.course_id" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.course_id ? 'border-rose-300' : 'border-slate-200'" required>
              <option value="" disabled>Select course</option>
              <template x-for="course in courseOptions" :key="course._id">
                <option :value="course._id" x-text="`${course.title} (${course._id})`"></option>
              </template>
            </select>
            <p class="mt-1 text-xs text-slate-500" x-show="!courseOptions.length">No courses available yet â create a course first.</p>
            <p x-show="errors.course_id" x-text="errors.course_id" class="mt-1 text-xs font-medium text-rose-600"></p>
          </div>
        </div>

        <div class="grid gap-5 sm:grid-cols-3">
          <div>
            <label for="section-semester" class="text-sm font-medium text-slate-700">Semester</label>
            <input id="section-semester" type="text" x-model="form.semester" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.semester ? 'border-rose-300' : 'border-slate-200'" placeholder="2025A" required />
            <p x-show="errors.semester" x-text="errors.semester" class="mt-1 text-xs font-medium text-rose-600"></p>
          </div>
          <div>
            <label for="section-number" class="text-sm font-medium text-slate-700">Section number</label>
            <input id="section-number" type="text" x-model="form.section_no" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.section_no ? 'border-rose-300' : 'border-slate-200'" placeholder="01" required />
            <p x-show="errors.section_no" x-text="errors.section_no" class="mt-1 text-xs font-medium text-rose-600"></p>
          </div>
          <div>
            <label for="section-capacity" class="text-sm font-medium text-slate-700">Capacity</label>
            <input id="section-capacity" type="number" min="0" step="1" x-model="form.capacity" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.capacity ? 'border-rose-300' : 'border-slate-200'" placeholder="30" />
            <p class="mt-1 text-xs text-slate-500">Leave blank if the seat count has not been assigned.</p>
            <p x-show="errors.capacity" x-text="errors.capacity" class="mt-1 text-xs font-medium text-rose-600"></p>
          </div>
        </div>

        <div class="grid gap-5 sm:grid-cols-2">
          <div>
            <label for="section-instructor" class="text-sm font-medium text-slate-700">Instructor ID</label>
            <input id="section-instructor" type="text" x-model="form.instructor_id" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.instructor_id ? 'border-rose-300' : 'border-slate-200'" placeholder="e.g. I-1001" />
            <p x-show="errors.instructor_id" x-text="errors.instructor_id" class="mt-1 text-xs font-medium text-rose-600"></p>
          </div>
          <div>
            <label for="section-room" class="text-sm font-medium text-slate-700">Room</label>
            <input id="section-room" type="text" x-model="form.room" class="mt-1 w-full rounded-xl border bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" :class="errors.room ? 'border-rose-300' : 'border-slate-200'" placeholder="ENG-201" />
            <p x-show="errors.room" x-text="errors.room" class="mt-1 text-xs font-medium text-rose-600"></p>
          </div>
        </div>

        <div>
          <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-slate-700">Meeting pattern</label>
            <button type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-600 hover:border-slate-300" @click="addScheduleRow()">
              <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 6v12m6-6H6" stroke-linecap="round" /></svg>
              Add meeting
            </button>
          </div>
          <p class="mt-1 text-xs text-slate-500">Specify recurring meetings. Leave empty if the schedule is still being coordinated.</p>
          <template x-if="errors.schedule">
            <p class="mt-2 text-xs font-medium text-rose-600" x-text="errors.schedule"></p>
          </template>
          <div class="mt-4 space-y-3" x-ref="scheduleList">
            <template x-if="!form.schedule.length">
              <p class="rounded-xl border border-dashed border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-500">No meetings added yet.</p>
            </template>
            <template x-for="(meeting, index) in form.schedule" :key="meeting.key">
              <div class="grid gap-3 rounded-xl border border-slate-200 bg-slate-50/60 px-4 py-3 sm:grid-cols-7 sm:items-end">
                <div class="sm:col-span-2">
                  <label :for="`meeting-dow-${meeting.key}`" class="text-xs font-medium text-slate-600">Day of week</label>
                  <select :id="`meeting-dow-${meeting.key}`" x-model="meeting.dow" class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200">
                    <option value="">Select</option>
                    <template x-for="day in meetingDays" :key="day">
                      <option :value="day" x-text="day"></option>
                    </template>
                  </select>
                </div>
                <div class="sm:col-span-2">
                  <label :for="`meeting-start-${meeting.key}`" class="text-xs font-medium text-slate-600">Start time</label>
                  <input :id="`meeting-start-${meeting.key}`" type="time" x-model="meeting.start" class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" />
                </div>
                <div class="sm:col-span-2">
                  <label :for="`meeting-end-${meeting.key}`" class="text-xs font-medium text-slate-600">End time</label>
                  <input :id="`meeting-end-${meeting.key}`" type="time" x-model="meeting.end" class="mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-200" />
                </div>
                <div class="sm:col-span-1 flex items-end">
                  <button type="button" class="inline-flex items-center gap-1 rounded-full border border-transparent bg-white px-3 py-1.5 text-xs font-medium text-rose-600 hover:border-rose-200 hover:bg-rose-50" @click="removeScheduleRow(meeting.key)">
                    <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M15 9 9 15m0-6 6 6" stroke-linecap="round" stroke-linejoin="round" /></svg>
                    Remove
                  </button>
                </div>
              </div>
            </template>
          </div>
        </div>

        <div class="flex items-center justify-end gap-3 pt-2">
          <button type="button" class="rounded-full border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 hover:border-slate-300 disabled:opacity-50" @click="closeModal()" :disabled="saving">Cancel</button>
          <button type="submit" class="inline-flex items-center gap-2 rounded-full bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-smooth disabled:opacity-50" :disabled="saving">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5.25 12.75 9 16.5l9-9" stroke-linecap="round" stroke-linejoin="round" /></svg>
            <span x-text="saving ? 'Savingâ¦' : 'Save section'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('sectionsPage', () => ({
        sections: [],
        courses: [],
        loading: true,
        loadError: '',
        searchTerm: '',
        selectedSemester: '',
        modalOpen: false,
        isEditing: false,
        saving: false,
        deletingId: '',
        toastTimeout: null,
        toast: { visible: false, message: '', detail: '', variant: 'success' },
        meetingDays: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
        form: {
          _id: '',
          course_id: '',
          semester: '',
          section_no: '',
          instructor_id: '',
          capacity: '',
          room: '',
          schedule: []
        },
        errors: {},
        get courseOptions() {
          return [...this.courses].sort((a, b) => a.title.localeCompare(b.title));
        },
        get courseMap() {
          return this.courses.reduce((acc, course) => {
            acc[course._id] = course.title;
            return acc;
          }, {});
        },
        get semesters() {
          return [...new Set(this.sections.map((section) => section.semester).filter(Boolean))].sort();
        },
        get filteredSections() {
          const term = this.searchTerm.trim().toLowerCase();
          return this.sections.filter((section) => {
            const matchesSemester = this.selectedSemester ? section.semester === this.selectedSemester : true;
            const matchesQuery = term
              ? [section._id, section.course_id].some((value) => String(value || '').toLowerCase().includes(term))
              : true;
            return matchesSemester && matchesQuery;
          });
        },
        formatMeeting(meeting) {
          if (!meeting || typeof meeting !== 'object') return '';
          const dow = String(meeting.dow || '').trim();
          const start = String(meeting.start || '').trim();
          const end = String(meeting.end || '').trim();
          if (dow && start && end) {
            return `${dow} ${start}â${end}`;
          }
          if (dow && (start || end)) {
            return `${dow} ${[start, end].filter(Boolean).join('â')}`;
          }
          return dow || [start, end].filter(Boolean).join('â');
        },
        init() {
          this.loadData();
        },
        async loadData() {
          this.loading = true;
          this.loadError = '';
          try {
            const [sections, courses] = await Promise.all([
              this.requestSections(),
              this.requestCourses().catch((error) => {
                console.error('Failed to load courses', error);
                this.showToast('Unable to load course catalog.', 'error', 'Course dropdown may be incomplete.');
                return [];
              })
            ]);
            this.sections = sections;
            this.courses = courses;
          } catch (error) {
            console.error('Failed to load sections', error);
            this.sections = [];
            this.courses = [];
            this.loadError = error instanceof Error ? error.message : 'Please refresh and try again.';
            this.showToast('Unable to load sections.', 'error', 'Check your network connection.');
          } finally {
            this.loading = false;
          }
        },
        async requestSections() {
          const response = await fetch('/api/sections');
          const payload = await response.json().catch(() => null);
          if (!response.ok || !Array.isArray(payload)) {
            const message = (payload && payload.error) || `Request failed with status ${response.status}`;
            throw new Error(message);
          }
          return payload.map((section) => {
            const meetings = Array.isArray(section.schedule)
              ? section.schedule
                  .map((entry) => ({
                    dow: String(entry?.dow ?? '').trim(),
                    start: String(entry?.start ?? '').trim(),
                    end: String(entry?.end ?? '').trim()
                  }))
                  .filter((entry) => entry.dow || entry.start || entry.end)
              : [];
            return {
              _id: section._id ?? '',
              course_id: section.course_id ?? '',
              course_title: section.course_title ?? '',
              semester: section.semester ?? '',
              section_no: section.section_no ?? '',
              instructor_id: section.instructor_id ?? '',
              capacity:
                section.capacity !== undefined && section.capacity !== null && section.capacity !== ''
                  ? Number(section.capacity)
                  : null,
              room: section.room ?? '',
              schedule: meetings
            };
          });
        },
        async requestCourses() {
          const response = await fetch('/api/courses?limit=500');
          const payload = await response.json().catch(() => null);
          if (!response.ok || !Array.isArray(payload)) {
            const message = (payload && payload.error) || `Request failed with status ${response.status}`;
            throw new Error(message);
          }
          return payload.map((course) => ({
            _id: course._id ?? '',
            title: course.title ?? course._id ?? ''
          }));
        },
        async refreshSections() {
          this.sections = await this.requestSections();
        },
        async refreshCoursesIfNeeded(courseId) {
          if (!courseId) return;
          const exists = this.courses.some((course) => course._id === courseId);
          if (!exists) {
            try {
              this.courses = await this.requestCourses();
            } catch (error) {
              console.error('Failed to refresh courses', error);
            }
          }
        },
        generateKey() {
          return `m-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
        },
        newScheduleRow() {
          return { key: this.generateKey(), dow: '', start: '', end: '' };
        },
        addScheduleRow() {
          this.form.schedule.push(this.newScheduleRow());
        },
        removeScheduleRow(key) {
          this.form.schedule = this.form.schedule.filter((meeting) => meeting.key !== key);
        },
        toScheduleRows(entries) {
          if (!Array.isArray(entries)) return [];
          return entries.map((entry) => ({
            key: this.generateKey(),
            dow: String(entry?.dow || '').trim(),
            start: String(entry?.start || '').trim(),
            end: String(entry?.end || '').trim()
          }));
        },
        resetForm() {
          this.form = {
            _id: '',
            course_id: '',
            semester: '',
            section_no: '',
            instructor_id: '',
            capacity: '',
            room: '',
            schedule: []
          };
        },
        openCreate() {
          this.isEditing = false;
          this.resetForm();
          this.errors = {};
          this.saving = false;
          this.modalOpen = true;
        },
        openEdit(section) {
          this.isEditing = true;
          this.resetForm();
          this.form._id = section._id;
          this.form.course_id = section.course_id;
          this.form.semester = section.semester;
          this.form.section_no = section.section_no;
          this.form.instructor_id = section.instructor_id || '';
          this.form.capacity = section.capacity != null ? String(section.capacity) : '';
          this.form.room = section.room || '';
          this.form.schedule = this.toScheduleRows(section.schedule);
          this.errors = {};
          this.saving = false;
          this.modalOpen = true;
        },
        closeModal() {
          if (this.saving) return;
          this.modalOpen = false;
          this.resetForm();
          this.errors = {};
          this.isEditing = false;
        },
        validate() {
          const nextErrors = {};
          if (!this.form._id.trim()) nextErrors._id = 'Section ID is required.';
          if (!this.form.course_id) nextErrors.course_id = 'Select a course.';
          if (!this.form.semester.trim()) nextErrors.semester = 'Semester is required.';
          if (!this.form.section_no.trim()) nextErrors.section_no = 'Section number is required.';
          if (this.form.capacity !== '') {
            const capacityNumber = Number(this.form.capacity);
            if (Number.isNaN(capacityNumber) || capacityNumber < 0) {
              nextErrors.capacity = 'Capacity must be zero or greater.';
            }
          }
          const hasPartialMeeting = this.form.schedule.some((meeting) => {
            const parts = [meeting.dow, meeting.start, meeting.end].map((value) => String(value || '').trim());
            const hasAny = parts.some((value) => value.length);
            const hasAll = parts.every((value) => value.length);
            return hasAny && !hasAll;
          });
          if (hasPartialMeeting) {
            nextErrors.schedule = 'Complete each meeting row or remove it.';
          }
          this.errors = nextErrors;
          return Object.keys(nextErrors).length === 0;
        },
        buildPayload() {
          const payload = {
            _id: this.form._id.trim(),
            course_id: this.form.course_id,
            semester: this.form.semester.trim().toUpperCase(),
            section_no: this.form.section_no.trim()
          };
          if (this.form.instructor_id.trim()) {
            payload.instructor_id = this.form.instructor_id.trim();
          }
          if (this.form.capacity !== '') {
            const capacityNumber = Number(this.form.capacity);
            if (!Number.isNaN(capacityNumber)) {
              payload.capacity = capacityNumber;
            }
          }
          if (this.form.room.trim()) {
            payload.room = this.form.room.trim();
          }
          const meetings = this.form.schedule
            .map((meeting) => ({
              dow: String(meeting.dow || '').trim(),
              start: String(meeting.start || '').trim(),
              end: String(meeting.end || '').trim()
            }))
            .filter((meeting) => meeting.dow && meeting.start && meeting.end);
          if (meetings.length) {
            payload.schedule = meetings;
          } else if (this.isEditing) {
            payload.schedule = [];
          }
          return payload;
        },
        async saveSection() {
          if (!this.validate()) {
            this.showToast('Please review the highlighted fields.', 'error', 'Missing required information.');
            return;
          }

          this.saving = true;
          const payload = this.buildPayload();
          const method = this.isEditing ? 'PUT' : 'POST';
          const url = this.isEditing
            ? `/api/sections/${encodeURIComponent(this.form._id)}`
            : '/api/sections';

          if (this.isEditing) {
            delete payload._id;
          }

          const courseIdForRefresh = this.form.course_id;
          const editing = this.isEditing;

          try {
            const response = await fetch(url, {
              method,
              headers: { 'Content-Type': 'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify(payload)
            });
            const result = await response.json().catch(() => null);

            if (!response.ok || !result) {
              const details = (result && result.details) || {};
              this.errors = { ...this.errors, ...details };
              const detailMessage =
                details.course_id ||
                details.section_no ||
                details.semester ||
                details.schedule ||
                Object.values(details)[0] ||
                (result && result.error === 'forbidden' ? 'Please try again later.' : '');
              const message =
                result && result.error === 'forbidden'
                  ? 'Unable to save section.'
                  : (result && result.error) || 'Unable to save section.';
              this.showToast(message, 'error', detailMessage);
              return;
            }

            await this.refreshSections();
            await this.refreshCoursesIfNeeded(courseIdForRefresh);
            this.closeModal();
            this.showToast(
              editing ? 'Section updated successfully.' : 'Section created successfully.',
              'success',
              editing ? 'Schedule refreshed.' : 'Section is ready for enrollment.'
            );
          } catch (error) {
            console.error('Failed to save section', error);
            this.showToast('Unable to save section.', 'error', 'Check your network connection.');
          } finally {
            this.saving = false;
          }
        },
        async deleteSection(id) {
          if (!window.confirm('Remove this section from the schedule?')) {
            return;
          }

          this.deletingId = id;

          try {
            const response = await fetch(`/api/sections/${encodeURIComponent(id)}`, {
              method: 'DELETE',
              credentials: 'same-origin'
            });
            const result = await response.json().catch(() => null);

            if (!response.ok || !result || !result.deleted) {
              const message =
                result && result.error === 'forbidden'
                  ? 'Unable to delete section.'
                  : (result && result.error) || 'Unable to delete section.';
              const detail =
                result && result.error === 'forbidden'
                  ? 'Please try again later.'
                  : 'Please try again in a moment.';
              this.showToast(message, 'error', detail);
              return;
            }

            this.sections = this.sections.filter((section) => section._id !== id);
            const detail = result.enrollments
              ? `${result.enrollments} enrollment(s) may require reassignment.`
              : 'Section removed from the schedule.';
            this.showToast('Section removed.', 'success', detail);
          } catch (error) {
            console.error('Failed to delete section', error);
            this.showToast('Unable to delete section.', 'error', 'Check your network connection.');
          } finally {
            this.deletingId = '';
          }
        },
        showToast(message, variant = 'success', detail = '') {
          if (this.toastTimeout) {
            clearTimeout(this.toastTimeout);
          }
          this.toast = { visible: true, message, variant, detail };
          this.toastTimeout = setTimeout(() => {
            this.toast.visible = false;
          }, 3200);
        }
      }));
    });
  </script>
</body>
</html>
